import{ai as p,aj as c,al as H,ao as fi,aS as ja,oU as Wa,aB as qa,aL as T,ce as Ja,bf as ut,sm as Ka,pM as Qa,i1 as tn,i$ as ba,kE as Gt,kH as ri,kF as en,q2 as an,kD as nn,ep as le,i3 as Ue,nS as sn,cq as P,aR as qt,kU as Sa,b1 as St,kX as z,np as li,hD as me,cd as gt,nD as $i,nF as Qe,kZ as Ii,nG as on,dt as nt,iC as Ne,kP as ve,k$ as Ci,wd as rn,d0 as ln,mb as Pi,c_ as hn,gT as pn,fr as cn,sb as un,we as dn,hI as Fe,hc as wa,pR as gn,cW as F,wf as Li,sc as yi,aH as kt,ah as $,ec as V,cX as It,oc as Xe,wg as xa,cL as _n,ag as $t,dp as zi,dn as mn,wh as vn,i2 as fn,wi as Oa,af as te,wj as De,wk as Ea,ih as Vi,kO as R,nl as q,o8 as S,oZ as yn,hp as Te,nk as Aa,cr as Z,nn as Ge,k_ as Mi,j_ as bi,cE as Ze,kS as Mn,wl as bn,wm as Sn,p3 as wn,sv as xn,kN as st,ds as hi,nb as pi,dr as Jt,p0 as On,o_ as En,hv as Ta,c1 as ci,c4 as An,cb as Da,aK as Tn,er as Ct,wn as Dn,wo as Ga,pQ as Gn,dV as fe,n9 as Ra,n8 as Si,uI as $a,wp as Rn,kL as Hi,dU as $n,b6 as wi,wq as In,hN as Tt,qt as ki,hk as Cn,n6 as Re,nU as be,fL as Pn,kM as Ln,sz as Ui,wr as zn,dF as ui,bD as Vn,o0 as yt,bC as Hn,pP as Ia,ws as kn,wt as Un,aM as $e,nm as Nn,wu as Ni,cx as he,wv as Fn,e6 as ce,p4 as Xn,o5 as Zn,s6 as Fi,ww as Xi,pz as Yn,cy as Bn,cz as jn,eu as di,pB as Wn,pA as qn,bN as Jn,ne as Se,e2 as Kn,en as Qn,n3 as ts,ng as ne,n5 as Zi,gA as ti,dR as we,n1 as es,i0 as is,n4 as as,p6 as ns}from"./index-a4349970.js";import{a as ss,s as os,i as rs,u as ls}from"./analysisThemeUtils-b08050c7.js";import{e as hs,q as ps,b as Ie,m as ue,r as de,o as ei}from"./quantityFormatUtils-2974964e.js";import{x as cs}from"./TextOverlayItem-7b4ef3d9.js";import{l as us,s as wt,d as ye,t as Ye,p as ds,b as gs}from"./automaticLengthMeasurementUtils-79250f0b.js";import{t as Ca,V as Pa,O as ge,_ as Yi,G as xi}from"./VerticesVisualElement-f9b7380c.js";import{h as _s,f as Kt,d as G,i as ms}from"./colorUtils-7cc910c1.js";import{t as vs}from"./RightAngleQuadVisualElement-7cc986dd.js";import{c as Ce,y as fs}from"./PointVisualElement-b46a295c.js";import{E as ys,I as Ms,H as bs,o as Ss,r as ws,M as Bi,U as xs,G as Os,F as xe,S as ji}from"./editPlaneUtils-f855a3f7.js";import{$ as Q,e as M,F as bt,x as gi,k as se,V as La,D as za,R as Es}from"./manipulatorUtils-a7f5fe3e.js";import{n as Vt}from"./manipulatorUtils-cc979c25.js";import{T as Oi,P as Va,M as As,U as Ts,k as Ds,D as Gs,H as _i,n as Rs}from"./Factory-f6836898.js";import{x as $s,z as Is,d as ot,D as pe,y as Cs,q as ee,U as Ha,P as Bt,l as Be,j as Ps,w as Ls,C as Wi,O as zs}from"./InteractiveToolBase-23f2c672.js";import{S as Vs}from"./GraphicManipulator-5634b878.js";import{_ as je,y as qi,N as Hs,E as Mt,e as Ji}from"./EditGeometryOperations-79080d62.js";import{e as Pe}from"./SnappingContext-81ddabf3.js";import{f as Le}from"./SnappingOperation-32fb892b.js";import{r as _e,p as We,a as Ei,l as ks,c as Us,n as Ns}from"./TranslateTooltipInfos-3ccdbf06.js";import{y as ze,R as Fs,j as Xs}from"./euclideanLengthMeasurementUtils-48e26d2a.js";import{o as Zs}from"./automaticAreaMeasurementUtils-d11fa303.js";import{N as Ki}from"./MeshTransform-010ec88d.js";import{$ as ka,J as Ys,O as Bs,s as js,e as Ws,T as qs,w as Js,z as Qi,H as Ks,p as Qs,k as to,X as eo,F as io}from"./sliceToolUtils-67b7b3e6.js";import{i as ao,p as no}from"./ExtentTooltipInfos-2332cacb.js";import"./unitFormatUtils-b3be9847.js";import"./geometryEngine-bd03308a.js";import"./geometryEngineBase-3417976c.js";import"./hydrated-4bfa4acf.js";import"./LineVisualElement-83b80b4d.js";import"./colorUtils-c0f43caf.js";import"./VisualElementResources-b74328d9.js";import"./centroid-3debfe1c.js";import"./dehydratedFeatureComparison-8b0f7a5e.js";import"./ImageMaterial-b1d6667d.js";import"./drawUtils-10a2add2.js";import"./drapedUtils-0ba0ca8e.js";import"./PointSnappingHint-32e249a2.js";import"./measurementUtils-c453c0ad.js";import"./euclideanAreaMeasurementUtils-d75fc03e.js";const so=3025,oo={default:15,far:25};let pt=class extends fi{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=ja(async i=>{const a=await Wa("esri/core/t9n/Units");qa(i),this._messagesUnits=a});this.addHandles([T(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>Ja(()=>{var a;return(a=this.context)==null?void 0:a.editGeometryOperations},i,()=>this._update())),ut(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return oo[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(t==null)return void this._destroyUnusedLabels();const{components:i,geometry:a,coordinateHelper:n}=t.editGeometryOperations.data;if(!a)return void this._destroyUnusedLabels();const s=i.length;for(let o=0;o<s;++o){const r=[];if(i[o].iterateVertices(_=>{r.push(n.toXYZ(_.pos))}),o===0&&this.stagedVertex!=null&&r.push(n.toXYZ(this.stagedVertex)),r.length<2)continue;const l=r[0],h=r[r.length-1];a.type==="polygon"&&r.length>2&&!Ka(l,h)&&r.push(l);const u=s===1&&!Qa(r,!1,!1);let d=ro,g=lo;this.toScreenPointArray(t,l,d);for(let _=1;_<r.length;++_){const m=r[_-1],v=r[_];this.toScreenPointArray(t,v,g),this._addLabel(t,m,d,v,g,u),[d,g]=[g,d]}}this._destroyUnusedLabels()}_addLabel(t,i,a,n,s,o){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||tn(a,s)<so)return void(r.visible=!1);const l=t.graphicState!=null?t.graphicState.isDraped?"on-the-ground":"absolute-height":ba(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:h}=t.editGeometryOperations.data,u=us(i,n,h,l),d=this._messagesUnits,g=hs(t.view);r.text=d!=null&&u!=null?ps(d,u,g):"",r.visible=!0;const _=s[0]-a[0],m=s[1]-a[1];o?Gt(tt,-m,_):Gt(tt,m,-_),ri(tt,tt),en(tt,tt,this._edgeDistancePixels),an(oe,a,s,.5),nn(oe,oe,tt),r.position=[oe[0],oe[1]],Math.abs(tt[0])>Math.abs(tt[1])?r.anchor=tt[0]>0?"left":"right":r.anchor=-tt[1]<0?"top":"bottom"}_getOrCreateLabel(t){var n;if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const i=new cs({anchor:"center",fontSize:10,textColor:ss(),backgroundColor:os(.6)});(n=t.view.overlay)==null||n.items.add(i);const a={label:i};return this._labelInfos.push(a),this._nextLabelIndex=this._labelInfos.length,a}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){var i,a;(a=(i=this.context)==null?void 0:i.view.overlay)==null||a.items.remove(t),t.destroy()}};p([c()],pt.prototype,"context",void 0),p([c()],pt.prototype,"stagedVertex",void 0),p([c()],pt.prototype,"visible",void 0),p([c()],pt.prototype,"edgeDistance",void 0),p([c()],pt.prototype,"updating",null),p([c()],pt.prototype,"_messagesUnits",void 0),p([c()],pt.prototype,"_edgeDistancePixels",null),pt=p([H("esri.views.interactive")],pt);const tt=le(),oe=le(),ro=Ue(),lo=Ue();let Ve=class extends pt{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:i,editGeometryOperations:a},n,s=Ue()){const{spatialReference:o}=a.data.coordinateHelper;return sn(n,o,i,t,ta),t.state.camera.projectToScreen(ta,s),s}};Ve=p([H("esri.views.3d.interactive.SegmentLabels3D")],Ve);const ta=P();function Ai(e){const{graphic:t}=e;return[T(()=>e.displaying,i=>{i?ho(t):ea(t)},{...qt}),ut(()=>ea(t))]}function ho(e){const{geometry:t}=e;Ua(t)&&e.notifyMeshTransformChanged({action:Sa.EnableFastUpdates})}function ea(e){const{geometry:t}=e;Ua(t)&&e.notifyMeshTransformChanged({action:Sa.DisableFastUpdates})}function Ua(e){return(e==null?void 0:e.type)==="mesh"&&!e.vertexSpace.isGeoreferenced}const rt=Ca(e=>({accent:rs(),contrast:ls(),selected:new St([255,255,255]),selectedOutline:new St([255,255,255]),staged:new St([12,207,255]),outline:new St([0,0,0,.5])})),Wt=.3;function xt(e,t){t&&Object.assign(e,t)}let po=class{constructor({theme:t,...i}){this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=z.Opaque,this.color=rt(t).accent,xt(this,i)}},ii=class{constructor({theme:t,...i}){this.size=11,this.outlineSize=1,this.collisionPadding=9;const a=rt(t);this.color=a.accent,this.outlineColor=a.outline,this.renderOccluded=z.Opaque,this.hoverOutlineColor=a.selectedOutline,xt(this,i)}apply(t,i){const a=this[t];i.setParameters({color:G(a),transparent:t!=="color"||a.a<1,renderOccluded:this.renderOccluded})}},co=class{constructor({theme:t,...i}){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.renderOccluded=z.Transparent,this.minSquaredEdgeLength=900;const a=rt(t);this.color=Kt(a.accent,.5),this.hoverColor=a.accent,xt(this,i)}apply(t,i){const a=this[t];i.setParameters({color:G(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}},uo=class{constructor({theme:t}){const i=rt(t);this.vertex=new ii({theme:t,color:i.accent,outlineColor:i.outline}),this.edge=new ii({theme:t,color:_s(Kt(i.accent,2/3),.5),outlineColor:Kt(i.outline,.5),size:8,collisionPadding:8}),this.selected=new ii({theme:t,color:i.selected,outlineColor:i.outline}),this.edgeOffset=new co({theme:t})}},mi=class{constructor({theme:t,...i}){this.width=1.5,this.stipplePattern=li(5),this.falloff=0,this.innerWidth=1.5,this.renderOccluded=z.OccludeAndTransparent;const a=rt(t);this.color=a.selected,this.stippleOffColor=a.outline,this.innerColor=a.selected,xt(this,i)}apply(t){t.color=G(this.color),t.width=this.width,t.stipplePattern=this.stipplePattern,t.stippleOffColor=G(this.stippleOffColor),t.falloff=this.falloff,t.innerWidth=this.innerWidth,t.innerColor=G(this.innerColor),t.renderOccluded=this.renderOccluded}},go=class{constructor({theme:t,...i}){this.size=4,this.outlineSize=1,this.shape="square";const a=rt(t);this.color=a.selected,this.outlineColor=a.outline,xt(this,i)}apply(t){t.color=G(this.color),t.size=this.size,t.outlineSize=this.outlineSize,t.outlineColor=G(this.outlineColor),t.primitive=this.shape}};class He{constructor({theme:t,...i}){this.innerWidth=1,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=Wt,this.globalAlphaContrastBoost=1.5,this.radius=3;const a=rt(t);this.innerColor=a.selected,this.glowColor=a.accent,this.heightFillColor=a.accent,xt(this,i)}apply(t,i=1){const a={glowColor:St.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:St.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=a:t.laserlineStyle=a}}class _o{constructor({theme:t,...i}){const a=rt(t);this.outline=new mi({theme:t,color:a.outline,renderOccluded:z.OccludeAndTransparentStencil,stippleOffColor:a.selected,stipplePattern:li(5),width:1.5,innerWidth:0}),this.staged=new mi({theme:t,color:a.selected,renderOccluded:z.OccludeAndTransparentStencil,innerColor:a.staged,stippleOffColor:a.outline,stipplePattern:li(5),width:1.5}),this.shadowStyle=new He({theme:t,globalAlpha:Wt,glowColor:a.accent,glowFalloff:8,glowWidth:8,innerColor:a.selected,innerWidth:1}),xt(this,i)}}let mo=class{constructor({theme:t,...i}){const a=rt(t);this.outline=new go({theme:t,color:a.selected,outlineColor:a.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new He({theme:t,globalAlpha:Wt,glowColor:a.accent,glowFalloff:1.5,glowWidth:6,innerColor:a.selected,innerWidth:1,radius:2}),xt(this,i)}},vo=class extends mi{constructor({theme:t,...i}){super({theme:t}),this.extensionType=Pa.GROUND_RAY,xt(this,i)}},fo=class{constructor({theme:t}){this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20;const i=rt(t);this.lineGraphics=new _o({theme:t}),this.pointGraphics=new mo({theme:t}),this.heightPlane=new He({theme:t,globalAlpha:Wt,glowColor:i.accent,glowFalloff:8,glowWidth:8,innerColor:i.selected,innerWidth:1}),this.heightBox=new He({theme:t,globalAlpha:Wt,glowColor:i.accent,glowFalloff:8,glowWidth:8,innerColor:i.selected,innerWidth:0,heightFillColor:i.accent}),this.zVerticalLine=new vo({theme:t,color:Kt(i.accent,5*Wt/3),falloff:2,innerColor:Kt(i.selected,0),renderOccluded:z.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Pa.GROUND_RAY})}},yo=class{constructor(t){this.colors=rt(t.theme),this.visualElements=new fo(t),this.manipulators=new uo(t),this.zManipulator=new po(t)}};const L=Ca(e=>new yo({theme:e}));let Ut=class extends vs{constructor(t){super(t),this._attachmentOrigin=me(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new gt,this._geometry=null,this._width=1,this._color=$i(1,0,1,1),this._innerWidth=0,this._innerColor=$i(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=z.OccludeAndTransparentStencil,this._attachmentOrigin.spatialReference=t.view.spatialReference,this._laserline=new Ce({view:t.view}),this.applyProps(t),this.attached=t.attached??!0}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(t){return{view:t,createResources:i=>this._createObject3DResources(i),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:(i,a)=>{i.geometries.length=0,this._recreateGeometry(a,i.material,i.geometries)}}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:i=>{i.geometries=this._createRenderGeometriesDraped(i.material),this._attachmentOriginChanged()}}}get _laserlineAttached(){return this.attached&&this.visible&&this._laserlineStyle!=null&&!this.isDraped&&this.laserlineEnabled}onAttachedChange(t){this._laserline.attached=this._laserlineAttached,t&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get color(){return this._color}set color(t){Qe(t,this._color)||(Ii(this._color,t),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){Qe(t,this._innerColor)||(Ii(this._innerColor,t),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=t!=null!=(this._stipplePattern!=null);this._stipplePattern=t,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&Qe(t,this._stippleOffColor)||(this._stippleOffColor=t?on(t):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this._laserlineAttached,t!=null&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get attachmentOrigin(){var a;if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=(a=this.object3dResources.resources)==null?void 0:a.geometries;if(!t||t.length===0)return null;nt(Nt,0,0,0);let i=0;for(const n of t)n.computeAttachmentOrigin(ia)&&(Ne(Nt,Nt,ia),i++);return i===0?null:(ve(Nt,Nt,1/i),this.view.renderCoordsHelper.fromRenderCoords(Nt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){this.object3dResources.resources!=null&&this.object3dResources.resources.material.setParameters(this._materialParameters),this.drapedResources.resources!=null&&this.drapedResources.resources.material.setParameters(this._materialParameters)}get _isClosed(){return this.geometry!=null&&this.geometry.type==="polygon"}get _materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this._isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this._normalizedRenderOccluded}}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===z.OccludeAndTransparentStencil?z.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(t,i,a){this._createRenderGeometries(i,a);for(const n of a)t.addGeometry(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_destroyExternalResources(t){t.geometries=[],t.material.dispose()}_createObject3DResources(t){const i=new Ci(this._materialParameters),a=new Array;return this._recreateGeometry(t,i,a),{material:i,geometries:a,forEach:n=>{n(i),a.forEach(n)}}}_createDrapedResources(){const t=new Ci(this._materialParameters);return{material:t,geometries:this._createRenderGeometriesDraped(t)}}_createRenderGeometriesDraped(t){const{geometry:i,view:a}=this,n=a.basemapTerrain.spatialReference;return i==null||n==null?[]:rn(i,n).lines.map(({position:s})=>{const o={overlayInfo:{spatialReference:n,renderCoordsHelper:a.renderCoordsHelper},attributeData:{position:s},removeDuplicateStartEnd:this._isClosed};return new ln(Pi(t,o))})}calculateMapBounds(t){if(this.object3dResources.resources==null)return!1;const i=this.view.renderCoordsHelper;for(const a of this.object3dResources.resources.geometries){const n=a.vertexAttributes.get(hn.POSITION),s=pn(n.data.length);cn(n.data,i.spatialReference,0,s,this.view.spatialReference,0,n.data.length/3),un(t,s)}return!0}_createRenderGeometries(t,i){const a=this.geometry;if(a==null)return;const n=dn(a,this.view.elevationProvider,this.view.renderCoordsHelper,Fe.fromElevationInfo(this.elevationInfo??new wa({mode:ba(a,null)}))),s=new Array;for(const{position:o,mapPositions:r}of n.lines){const l={mapPositions:r,attributeData:{position:o},removeDuplicateStartEnd:this._isClosed};i.push(Pi(t,l)),s.push(o)}this._laserline.pathVerticalPlane=s}};const ia=P(),Nt=P();let J=class extends gt.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};p([c({constructOnly:!0})],J.prototype,"graphic",void 0),p([c()],J.prototype,"tracking",void 0),p([c()],J.prototype,"displaying",void 0),p([c()],J.prototype,"isDraped",void 0),J=p([H("esri.views.3d.layers.graphics.GraphicState")],J);let Ft=class extends ys{constructor(e){super(e),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:e,offset:t}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new wa({mode:e,offset:t})}normalizeCtorArgs(e){if(!e.elevationInfo){const t=e.hasZ??!0;return{...e,elevationInfo:gn(t)}}return e}initializeGraphic(e){const{view:t}=this,i=this._createGraphicState=new J({graphic:e});return F([t.maskOccludee(e),t.trackGraphicState(i),T(()=>({element:this._outlineVisualElement,isDraped:i.isDraped}),({element:a,isDraped:n})=>{a&&(a.isDraped=n)},qt),this._setupLoadingIndicator(i),...Ai(i)])}makeDrawOperation(){const{geometryType:e}=this,t=e!=="circle"&&e!=="rectangle";return new Ms({view:this.view,manipulators:this.manipulators,geometryType:bs(e),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ss(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new ws(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new ge,segmentLabels:t?new Ve:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Li(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(e){const{view:t}=this,i=L(t);if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[e],this._updateVerticalLineVisualElement(e),null;const a=i.manipulators,n=a.vertex;this._activeVertexVisualElement=new Yi({view:t,spatialReference:t.spatialReference,vertices:[e],elevationInfo:this.internalGraphicsLayer.elevationInfo,color:G(n.color),size:n.size,outlineColor:G(n.outlineColor),outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=G(a.selected.color),this._activeVertexVisualElement.attached=!0;const s=i.visualElements.zVerticalLine;return this._verticalLineVisualElement=new xi({view:t,extensionType:s.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:z.OccludeAndTransparent}),s.apply(this._verticalLineVisualElement),ut(()=>{this._activeVertexVisualElement=$(this._activeVertexVisualElement),this._verticalLineVisualElement=$(this._verticalLineVisualElement)})}_updateVerticalLineVisualElement(e){const t=this._verticalLineVisualElement;if(!t)return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;nt(Xt,e[0],e[1],e[2]),aa.setFromElevationInfo(this.elevationInfo),Xt[2]=yi(Xt,a,aa,i),i.toRenderCoords(Xt,this.view.spatialReference,Xt)?(t.setStartEndFromWorldDownAtLocation(Xt),t.attached=!0):t.attached=!1}onOutlineChanged(e){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=e,null;const t=this.internalGraphicsLayer.elevationInfo,{view:i}=this,a=L(i);return this._outlineVisualElement=new Ut({view:i,geometry:e,elevationInfo:t,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Li(this.hasZ,t)==="on-the-ground",attached:!1}),a.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),a.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,ut(()=>{this._outlineVisualElement=$(this._outlineVisualElement)})}onRegularVerticesChanged(e){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=e,null;const{view:t}=this,i=L(t).manipulators.vertex;return this._verticesVisualElement=new Yi({view:t,spatialReference:t.spatialReference,vertices:e,elevationInfo:this.internalGraphicsLayer.elevationInfo,color:G(i.color),size:i.size,outlineColor:G(i.outlineColor),outlineSize:i.outlineSize,renderOccluded:i.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,ut(()=>{this._verticesVisualElement=$(this._verticesVisualElement)})}_updateGraphicGeometry(e,t){if(this.geometryType==="mesh"&&(t==null?void 0:t.type)==="point"){const i=this.geometryToPlace;return i&&i.centerAt(t),void(i&&e.geometry===i?i.vertexSpace.isGeoreferenced?e.notifyGeometryChanged():e.notifyMeshTransformChanged():e.geometry=i)}super._updateGraphicGeometry(e,t)}_setupLoadingIndicator(e){const{drawOperation:t}=this;if(!this.geometryToPlace)return t.loading=!1,null;t.loading=!0;const i=ut(()=>{t.loading=!1});let a;const n=()=>a&&cancelAnimationFrame(a);return F([kt(()=>e.displaying,()=>{n(),a=requestAnimationFrame(()=>i.remove())},{...qt,once:!0}),ut(n),i])}};p([c({constructOnly:!0})],Ft.prototype,"elevationInfo",void 0),p([c({constructOnly:!0})],Ft.prototype,"geometryType",void 0),p([c()],Ft.prototype,"type",void 0),p([c({constructOnly:!0})],Ft.prototype,"view",void 0),Ft=p([H("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Ft);const aa=new Fe,Xt=P();var at;(function(e){e[e.NONE=0]="NONE",e[e.ANY=1]="ANY",e[e.Z=2]="Z",e[e.XY=4]="XY"})(at||(at={}));var A;(function(e){e[e.TRANSLATE_Z=0]="TRANSLATE_Z",e[e.TRANSLATE_XY=1]="TRANSLATE_XY",e[e.SCALE=2]="SCALE",e[e.ROTATE=3]="ROTATE",e[e.SCALE_ROTATE=4]="SCALE_ROTATE"})(A||(A={}));let Na=class{constructor(){this.grabbingState=at.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=at.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((i,a)=>{if(a===A.TRANSLATE_Z&&(this.zManipulator=i),i instanceof Q&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),this.firstGrabbedXY==null&&i.grabbing&&a===A.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=at.ANY,a){case A.TRANSLATE_Z:this.grabbingState|=at.Z;break;case A.TRANSLATE_XY:this.grabbingState|=at.XY}})}};function Mo(e){const{view:t,graphic:i}=e,a=new J({graphic:i}),n=bo(e,a),s=[n,So(e,n.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:n.visualElement,remove:()=>F(s).remove()}}function bo(e,t){const{view:i,graphic:a}=e,n=new Ut({view:i,geometry:vi(a)?a.geometry:null,elevationInfo:V(a),attached:!1}),s=L(i).visualElements.lineGraphics;s.shadowStyle.apply(n);const o=()=>{n.attached=t.displaying};s.outline.apply(n);const r=[T(()=>t.displaying,o),T(()=>t.isDraped,l=>{n.isDraped=l}),t.on("changed",()=>n.geometry=vi(a)?a.geometry:null),It(n)];return o(),{visualElement:n,remove:()=>F(r).remove()}}function So(e,t,i){const{graphic:a,view:n}=e,s=[],o=V(a),r=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",l=new Na,h=L(n).visualElements,u=new xi({view:n,extensionType:h.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:z.OccludeAndTransparent});h.pointGraphics.shadowStyle.apply(u);const d=Xe(h.heightPlaneAngleCutoff),g=new Ce({view:n,attached:!1,angleCutoff:d});h.heightPlane.apply(g);let _=1,m=1;const v=()=>{if(l.update(e),!i.displaying||r&&(i.isDraped||!vi(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,u.attached=!1,void(g.attached=!1);t.laserlineEnabled=!0;const O=l.grabbingState&at.XY?h.laserlineAlphaMultiplier:1;O!==_&&(_=O,h.lineGraphics.shadowStyle.apply(t,O),h.pointGraphics.shadowStyle.apply(u,O));const b=l.grabbingState&at.Z?h.laserlineAlphaMultiplier:1;b!==m&&(m=b,h.heightPlane.apply(g,b)),wo(u,l),xo(e,t,g,l)};h.zVerticalLine.apply(u),s.push(i.on("changed",v),T(()=>i.displaying,v),t.events.on("attachment-origin-changed",v),It(u),It(g));const f=[],x=()=>{F(f).remove(),f.length=0,e.forEachManipulator(O=>f.push(O.events.on("grab-changed",v))),e.forEachManipulator(O=>f.push(O.events.on("select-changed",v))),v()};return x(),s.push(e.onManipulatorsChanged(x),xa(()=>F(f))),F(s)}function wo(e,t){const i=t.numSelected===1?t.firstSelected:t.numSelected>1&&t.firstGrabbedXY!=null?t.firstGrabbedXY:null;i!=null?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}function xo(e,t,i,a){if(a.numSelected>0){nt(Lt,0,0,0);let n=0;e.forEachManipulator((s,o)=>{o===A.TRANSLATE_XY&&s.selected&&s instanceof Q&&(Ne(Lt,Lt,s.renderLocation),n++)}),n>0?(i.heightManifoldTarget=ve(Lt,Lt,1/n),i.attached=!0):i.attached=!1}else{const n=t.attachmentOrigin;n!=null&&e.view.renderCoordsHelper.toRenderCoords(n,Lt)?(i.heightManifoldTarget=Lt,i.attached=!0):i.attached=!1}}function vi(e){return e.geometry!=null&&(e.geometry.type==="polygon"||e.geometry.type==="polyline")}const Lt=P();function Oo(e){const{view:t,graphic:i}=e,a=new J({graphic:i}),n=[],s=Ao(e,a,n);return Eo(e,a,n,s),n.push(t.trackGraphicState(a)),{visualElement:s,remove(){F(n).remove()}}}function Eo(e,t,i,a){const{view:n,graphic:s}=e,o=L(n),r=new xi({view:n,extensionType:o.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:z.OccludeAndTransparent});o.visualElements.zVerticalLine.apply(r);const l=new Ce({view:n,intersectsLineInfinite:!0,attached:!1});o.visualElements.pointGraphics.shadowStyle.apply(l);const h=Xe(o.visualElements.heightPlaneAngleCutoff),u=new Ce({view:n,attached:!1,angleCutoff:h});o.visualElements.heightPlane.apply(u);const d=V(e.graphic),g=Fe.fromElevationInfo(d),_=d.mode==="on-the-ground"||!d.offset&&d.mode!=="absolute-height",m=new Na;let v=1,f=1;const x=()=>{m.update(e);const O=Ti(s),b=_&&(t.isDraped||O==null||!O.hasZ);let k=!0;if(b||O==null)k=!1;else{const K=yi(O,n.elevationProvider,g,n.renderCoordsHelper);nt(it,O.x,O.y,K),zi(it,O.spatialReference,it,n.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(it),l.intersectsWorldUpAtLocation=it}const X=m.grabbingState&at.Z?o.visualElements.laserlineAlphaMultiplier:1;X!==v&&(v=X,o.visualElements.heightPlane.apply(u,X));const Ot=mn(Ro);!b&&t.displaying&&a.calculateMapBounds(Ot)&&zi(vn(Ot,it),n.spatialReference,it,n.renderCoordsHelper.spatialReference)?(u.heightManifoldTarget=it,u.attached=!0):u.attached=!1;const ie=m.grabbingState&at.XY?o.visualElements.laserlineAlphaMultiplier:1;ie!==f&&(f=ie,o.visualElements.pointGraphics.shadowStyle.apply(l,ie));const E=k&&t.displaying&&!b;l.attached=E,r.attached=E};i.push(T(()=>[t.displaying,t.isDraped],x),t.on("changed",x)),e.forEachManipulator(O=>{i.push(O.events.on("grab-changed",x))}),i.push(It(l)),i.push(It(r)),i.push(It(u)),x()}function Ao(e,t,i){const{view:a,graphic:n}=e,s=new fs({view:a,geometry:Ti(n),elevationInfo:V(n),attached:!1});return To(e,s,t,i),i.push(It(s)),s}function Ti(e){const t=e.geometry;return t==null?null:t.type==="point"?t:t.type==="mesh"?t.anchor.clone():null}function To(e,t,i,a){const n=()=>t.attached=i.displaying;Do(e,t,i,a),L(e.view).visualElements.pointGraphics.outline.apply(t),a.push(T(()=>i.displaying,n,$t))}function Do(e,t,i,a){const{view:n,graphic:s}=e;let o=null;const r=h=>{o!=null&&(o.remove(),o=null),i.isDraped&&h!=null&&(o=Go(n,h,()=>{t.geometry=h}))},l=()=>{const h=Ti(s);r(h),t.geometry=h};a.push(i.on("changed",l),xa(()=>o)),l()}function Go(e,t,i){const a=e.elevationProvider.spatialReference;fn(t,it,a);const n=it[0],s=it[1];return e.elevationProvider.on("elevation-change",o=>{Oa(o.extent,n,s)&&i()})}const it=P(),Ro=_n();function qe(e){switch(e.graphic.geometry.type){case"point":case"mesh":return Oo(e);case"polygon":case"polyline":return Mo(e);default:return null}}const Fa=128,dt=70,$o=80,Xa=.02,Io=54,Co=100,Za=Math.ceil(dt/3*2),zt=160,ai=.5,ni=24,Zt=9,Po=zt+30,na=zt+53,Lo=60,zo=23,Vo=5*Math.PI/12,Ho=1*Math.PI/3,sa=10,oa=.2,ra=30,la=53,ha=.2,pa=.3,ko=200,Uo=3,No=1e6;let Me=class{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(i=>i.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(i=>i.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(i=>i.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(i=>{t||(t=i.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(i=>i.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}hasManipulator(t){return this.someManipulator(i=>i===t)}someManipulator(t){let i=!1;return this.forEachManipulator(a=>{!i&&t(a)&&(i=!0)}),i}_forEachManipulator3D(t){this.forEachManipulator((i,a)=>{i instanceof Q&&t(i,a)})}};function Je(e,t,i,a){const n=e.graphic,s=(o,r)=>t({action:o,graphic:n,dxScreen:r.screenDeltaX,dyScreen:r.screenDeltaY});return i((o,r,l)=>(r.next(h=>(h.action==="start"&&s("start",h),h)).next($s(n,a)).next(h=>{switch(h.action){case"start":case"update":(h.translationX||h.translationY||h.translationZ)&&s("update",h);break;case"end":s("end",h)}return h}),{steps:r,cancel:l=l.next(Is(n)).next(h=>(s("end",{screenDeltaX:0,screenDeltaY:0}),h))}))}function Ya(e){if(e==null||e.type!=="polyline"&&e.type!=="polygon")return 0;const t=(e.type==="polyline"?e.paths:e.rings)[0];if(!t||t.length<2)return 0;const i=t[0],a=t[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}function ke(e){if(e==null||e.axis==null)return 1;const{mapStart:t,mapEnd:i,axis:a}=e,n=[i.x-t.x,i.y-t.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}let Fo=class extends Me{constructor(t){super(),this._handles=new te,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=dt,this._updateAfterDrag=!1,this.events=new gt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=$(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:i}of this._arrowManipulatorInfos)t(i,A.TRANSLATE_XY)}createGraphicDragPipeline(t,i,a){const n=i.graphic,s=V(n),o=n.geometry.spatialReference;return Je(i,a,r=>this.createDragPipeline((l,h,u,d,g)=>({steps:h,cancel:u}=t(l,h,u,d,g),r(l,h,u)),s,o,n),this._view.state.viewingMode)}createDragPipeline(t,i,a,n){return F(this._arrowManipulatorInfos.map(({manipulator:s},o)=>ot(s,(r,l,h,u,d)=>{const g=l.next(_=>({..._,manipulatorType:A.TRANSLATE_XY})).next(pe(this._view,r.elevationAlignedLocation)).next(Oi(this._view,r.elevationAlignedLocation,i,a,n)).next(Cs(r.location,this.angle+(o+1)*Math.PI*.5)).next(ee());t(r,g,h,u,d)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:i},a){const n=this._radius/dt,s=Io*n,o=s*Math.sqrt(3)/2,r=De(this._opaqueMaterial,o,s/2,s/2,Xa);Ea(r,Vi(q.get(),nt(R.get(),0,-o/3,0))),t.renderObjects=[new M(r,S.Focused),new M(r.instantiate({material:this._transparentMaterial}),S.Unfocused)],t.radius=o/3*2*1.2;const l=yn(q.get(),a*Math.PI/2),h=Vi(q.get(),nt(R.get(),0,Co*n,0));Te(i,l,h)}_createManipulators(){for(let t=0;t<4;t++){const i=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,i=Aa(q.get(),t,Z(0,0,1));if(i==null)return;const a=Ge(q.get(),nt(R.get(),this.displayScale,this.displayScale,this.displayScale)),n=Te(q.get(),a,i);for(const s of this._arrowManipulatorInfos){const o=Te(q.get(),n,s.transform);s.manipulator.modelTransform=o}}_createArrowManipulator(t){const i=new Q({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Z(0,0,1)}}),a={manipulator:i,transform:Ze()};return this._updateArrowManipulator(a,t),this._handles.add(i.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const i=L(this._view),a=St.toUnitRGBA(i.colors.accent);return a[3]*=t,new Mi({color:a,transparent:t!==1,cullFace:bi.Back,renderOccluded:z.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:t})=>t)}}},Xo=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const i=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){const n={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?a:i,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(n)}}this._enabled=t}_snap(t){const i=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return i!=null&&this._view!=null&&(i.z=Mn(i,this._view,this._elevationInfo)),i}createDragEventPipelineStep(t,i){this._view=t,this._elevationInfo=i,this._lastDragEvent=null;const a=new Ha;return this._next=a,[n=>{if(this._lastDragEvent=n.action!=="end"?{...n}:null,this._enabled){const s=this._snap(n.screenEnd);return s!=null?{action:n.action,mapStart:n.mapStart,mapEnd:s,screenStart:n.screenStart,screenEnd:n.screenEnd}:null}return{action:n.action,mapStart:n.mapStart,mapEnd:n.mapEnd,screenStart:n.screenStart,screenEnd:n.screenEnd}},a]}},Zo=class extends Me{constructor(t){super(),this._snapToScene=new Xo,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=dt,this._view=t.view,this._tool=t.tool,t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,A.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,i,a){const n=i.graphic,s=V(n),o=n.geometry.spatialReference;return Je(i,a,r=>this.createDragPipeline((l,h,u,d,g)=>({steps:h,cancel:u}=t(l,h,u,d,g),r(l,h,u)),s,o,n),this._view.state.viewingMode)}createDragPipeline(t,i,a,n){const s=this._view;return ot(this._manipulator,(o,r,l,h,u)=>{const d=r.next(pe(s,o.elevationAlignedLocation)).next(Oi(s,o.elevationAlignedLocation,i,a,n)).next(...this._snapToScene.createDragEventPipelineStep(s,i)).next(g=>({...g,manipulatorType:A.TRANSLATE_XY})).next(ee());t(o,d,l,h,u)})}_updateManipulatorTransform(){const t=Ge(q.get(),nt(R.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new Q({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Z(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=bn(this._discMaterial,Xa,1,Fa,Z(0,0,1),Z(0,0,0));t.transformation=Ge(Ze(),Z(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new M(t,S.Focused),new M(t.instantiate({material:this._discMaterialTransparent}),S.Unfocused)],this._manipulator.radius=$o*(this._radius/dt)}_createMaterial(t=1){const i=L(this._view),a=St.toUnitRGBA(i.colors.accent);return a[3]*=t,new Mi({color:a,transparent:t!==1,cullFace:bi.Back,renderOccluded:z.Transparent})}get test(){return{discManipulator:this._manipulator}}};class Yo extends Me{constructor(t){super(),this._radius=dt,this.events=new gt,this._tool=t.tool,this._view=t.view,t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._manipulator.applyObjectTransform=jo,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,A.TRANSLATE_Z)}createGraphicDragPipeline(t,i,a){const n=i.graphic.geometry.spatialReference;return Je(i,a,s=>this.createDragPipeline((o,r,l,h,u)=>({steps:r,cancel:l}=t(o,r,l,h,u),s(o,r,l)),n),this._view.state.viewingMode)}createDragPipeline(t,i){const a=this._view;return ot(this._manipulator,(n,s,o,r,l)=>{const h=s.next(u=>({...u,manipulatorType:A.TRANSLATE_Z})).next(Va(a,n.renderLocation,i)).next(ee());t(n,h,o,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._radius/dt,i=L(this._view),a=i.zManipulator.height*t,n=i.zManipulator.coneHeight*t,s=i.zManipulator.coneWidth*t,o=i.zManipulator.width*t,r=[Z(0,0,0),Z(0,0,a)],l=[Z(0,0,0),Z(0,0,a+n)],h=O=>{const b=Ze();if(On(b,b,[0,0,a]),En(b,b,Math.PI/2),O){const k=1+2*O/s;Ta(b,b,[k,k,k])}return b},u=h(0),d=(O,b)=>{const k=ms(i.zManipulator.color,b);return k.a*=O,St.toUnitRGBA(k)},g=bt(d(1,.25),z.Occlude),_=bt(d(1,0),z.Occlude),m=bt(d(.7,0),i.zManipulator.renderOccluded),v=bt(d(.85,0),i.zManipulator.renderOccluded),f=Sn(g,r,o/2,16,!1),x=wn(g,n,s/2,16,!1);x.transformation=u,this._manipulator.renderObjects=[new M(x,S.Unfocused),new M(f,S.Unfocused),new M(x.instantiate({material:_}),S.Focused),new M(f.instantiate({material:_}),S.Focused),new M(x.instantiate({material:m}),S.Unfocused),new M(f.instantiate({material:m}),S.Unfocused),new M(x.instantiate({material:v}),S.Focused),new M(f.instantiate({material:v}),S.Focused)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,i=L(t),a=new Q({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});a.applyObjectTransform=n=>{const s=t.state.camera,o=ca;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);const r=xn(s.eye,o),l=s.computeRenderPixelSizeAtDist(r),h=st(Yt,o,s.eye);hi(h,h);const u=Bo;t.renderCoordsHelper.worldUpAtPosition(ca,u);const d=Math.abs(pi(h,u)),g=Jt(Yt,h,u),_=Jt(Yt,g,u),m=ci(d,.01,1),v=1-Math.sqrt(1-m*m)/m/s.fullWidth,f=this._radius/dt,x=i.zManipulator.width*f;ve(_,hi(_,_),(1/v-1)*r+l*x),n[12]-=Yt[0],n[13]-=Yt[1],n[14]-=Yt[2]},this._manipulator=a,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const ca=P(),Yt=P(),Bo=P(),jo=()=>{};class Ht extends Me{constructor(t){super(),this._handles=new te,this._interactive=!0;const{tool:i,view:a,snapToScene:n,radius:s}=t;this._view=a,this.xyManipulation=new Zo({tool:i,view:a,snapToScene:n,radius:s}),this.xyAxisManipulation=new Fo({tool:i,view:a,radius:s}),this.zManipulation=new Yo({tool:i,view:a,radius:s}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,i,a){return F([this.xyManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(y.XY,n,s,o,r,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(y.XY_AXIS,n,s,o,r,l),i,a),this.zManipulation.createGraphicDragPipeline((n,s,o,r,l)=>t(y.Z,n,s,o,r,l),i,a)])}createDragPipeline(t,i,a,n){return F([this.xyManipulation.createDragPipeline((s,o,r,l,h)=>t(y.XY,s,o,r,l,h),i,a,n),this.xyAxisManipulation.createDragPipeline((s,o,r,l,h)=>t(y.XY_AXIS,s,o,r,l,h),i,a,n),this.zManipulation.createDragPipeline((s,o,r,l,h)=>t(y.Z,s,o,r,l,h),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(i=>t(i,A.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>t(i,A.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>t(i,A.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(An("esri-mobile"))return;const a=[];i.forEachManipulator(s=>a.push(s)),t.forEachManipulator(s=>a.push(s));const n=()=>{const s=[];this._xyAxisVisible||t.forEachManipulator(o=>s.push(o.disableDisplay())),this._handles.remove(ua),this._handles.add(s,ua)};for(const s of a)this._handles.add(s.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(kt(()=>{var s;return(s=this._view.inputManager)==null?void 0:s.latestPointerType},n)),n()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(i=>{i.interactive=!t&&this._interactive||i.grabbing})}static radiusForSymbol(t){const i=t!=null&&t.type==="point-3d"&&t.symbolLayers;return i&&i.length>0&&i.some(a=>a.type==="icon")?Za:dt}}const ua="disable-xy-axis-display";var y;(function(e){e[e.XY=0]="XY",e[e.XY_AXIS=1]="XY_AXIS",e[e.Z=2]="Z"})(y||(y={}));class Di extends Me{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,A.TRANSLATE_XY)}createGraphicDragPipeline(t){return Je(this._graphicState,t,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(t){const i=this._view,a=this._graphicState.graphic,n=a.geometry!=null?a.geometry.spatialReference:null;return ot(this._manipulator,(s,o,r,l,h)=>{const u=o.next(As(h,i,a,n)).next(Bt()).next(ee());t(s,u,r,l,h)})}_createManipulator(){const t=this._view,i=this._graphicState.graphic;this._manipulator=new Vs({graphic:i,view:t,selectable:!0,cursor:"move"})}}let Wo=class{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}};class qo{constructor(t,i,a){this.dx=t,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class da{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const ht="manipulators";let _t=class extends Da(gt.EventedMixin(Be)){constructor(e){super(e),this._infos=new Map,this.graphics=new Tn,this.enableZ=!0,this.tooltipOptions=new Ct,this.type="move-3d",this._moveManipulation=null,this._tooltip=null}initialize(){const{view:e}=this;this.addHandles([this.graphics.on("change",i=>{i.removed.forEach(a=>this.removeHandles(a)),this._updateGraphicInfos(i),this._setupFastTransformUpdates(i.added),this._refreshManipulators()}),T(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new ye({view:e}):$(this._tooltip)},qt)]);const t=this.graphics.toArray();this._updateGraphicInfos({added:t,removed:[]}),this._setupFastTransformUpdates(t),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=$(this._tooltip),this._moveManipulation=$(this._moveManipulation),this.removeAllHandles(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_updateGraphicInfos({added:e,removed:t}){var i;for(const a of e){if(Dn(a)!==Ga.SUPPORTED)continue;const n=new Jo(a),s=this.view.trackGraphicState(n.state);this._infos.set(n.graphic,{info:n,handle:s})}for(const a of t)(i=this._infos.get(a))==null||i.handle.remove(),this._infos.delete(a)}_setupFastTransformUpdates(e){for(const t of e){const{info:i}=this._infos.get(t);this.addHandles(Ai(i.state),t)}}_refreshManipulators(){if(this.removeHandles(ht),this._moveManipulation=$(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const e=Array.from(this._infos.values(),({info:t})=>t);this._createManipulators(e),this._createVisualElements(e),this._updateMoveManipulation(e)}_createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Di({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator(a=>this.addHandles([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:i.graphic}),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{const{tooltipOptions:s,_tooltip:o}=this;o!=null&&(n==="start"?o.info=new _e({tooltipOptions:s}):o.clear())})],ht)),this.addHandles(t.manipulationXY.createDragPipeline((a,n,s,o)=>this._buildDragEventPipeline(e,y.XY,a,n,s,o)),ht)}this._createMoveManipulation(e)}_createMoveManipulation(e){const t=new Ht({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:e.length===1?Ht.radiusForSymbol(e[0].graphic.symbol):dt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(s=>{this.addHandles(s.events.on("immediate-click",o=>{t.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...o,graphic:this.graphics.at(0)}),o.stopPropagation()}),ht)});const i=s=>o=>{this.addHandles(o.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(e,s):l.clear())}),ht)};this._moveManipulation.xyManipulation.forEachManipulator(i(y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(y.Z));const a=()=>this._updateMoveManipulation(e);for(const s of e)this.addHandles([s.state.on("changed",a),T(()=>s.state.displaying,a)],ht);const n=e[e.length-1];this.addHandles(n.state.on("changed",()=>this._updateMoveManipulationAngle(n)),ht),this.addHandles(t.createDragPipeline((s,o,r,l,h)=>this._buildDragEventPipeline(e,s,o,r,l,h),V(n.graphic),n.graphic.geometry.spatialReference,n.graphic),ht),this._updateMoveManipulationAngle(n)}_createVisualElements(e){for(const t of e){const i=t.graphic,a=qe({view:this.view,graphic:i,forEachManipulator:n=>{var s,o;(s=t.manipulationXY)==null||s.forEachManipulator(n),(o=this._moveManipulation)==null||o.forEachManipulator(n)},onManipulatorsChanged:()=>ut()});a!=null&&(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Ut&&this.addHandles([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.state.isDraped||this._updateMoveManipulation(e)}),T(()=>t.state.isDraped,()=>this._updateMoveManipulation(e))],ht),this.addHandles(a,ht))}}_updateMoveManipulationAngle(e){this._moveManipulation&&(this._moveManipulation.angle=Ya(e.graphic.geometry))}_updateMoveManipulation(e){const t=me(0,0,0,this.view.spatialReference);let i=0,a=!1;const n=this._moveManipulation;if(n){for(const s of e){if(!s.state.displaying)continue;const o=s.state.graphic;this.enableZ&&Vt(o)&&(a=!0);const r=s.geometryRepresentation instanceof Ut&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:gi(this.view,o);if(r!=null){const{x:l,y:h,z:u}=r;t.x+=l,t.y+=h,u&&(t.z??(t.z=0),t.z+=u),i++}}i>0?(t.x/=i,t.y/=i,t.z??(t.z=0),t.z/=i,n.location=t,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(e,t,i,a,n,s){const o=[],r=[];let l=null,h=null;const u=()=>{for(const d of o)d.dragging=!1;o.length=0,r.length=0,l=null,h=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(e.length===1&&t===y.XY){const d=e[0].graphic;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(d,V(d),a,n,s))}return n=n.next(d=>h==null?void 0:h(d)).next(()=>(this.emit("graphic-move-stop",new da(r)),this.destroyed||u(),null)),{steps:a=a.next(d=>{var g,_;if(d.action==="start"){o.length=0,r.length=0;for(const m of e)m.dragging||!((g=m.manipulationXY)!=null&&g.hasManipulator(i))&&((_=m.manipulationXY)!=null&&_.grabbing)||(o.push(m),r.push(m.graphic),m.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=Ps(r,this.view.state.viewingMode),h=Ls(r),this.emit("graphic-move-start",new Wo(r)),this.destroyed))return null}return r.length!==0?d:null}).next(d=>l==null?void 0:l(d)).next(d=>(this._updateMoveTooltip(e,t,d),d)).next(d=>{switch(d.action){case"start":case"update":if(d.translationX||d.translationY||d.translationZ){const g=this.view.toScreen(d.mapStart),_=this.view.toScreen(d.mapEnd),m=_.x-g.x,v=_.y-g.y;if(this.emit("graphic-move",new qo(m,v,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new da(r)),this.destroyed)return null;u()}return null}),cancel:n}}_updateMoveTooltip(e,t,i){const{tooltipOptions:a,_tooltip:n}=this;if(n==null)return;n.clear();const s=e.length===0?"absolute-height":e[0].state.isDraped?"on-the-ground":"absolute-height";switch(t){case y.XY:n.info=new _e({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,(o,r)=>wt(o,r,s));break;case y.XY_AXIS:n.info=new Ei({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,(o,r)=>{const l=wt(o,r,s);return Ie(l,ke(i))});break;case y.Z:n.info=new We({tooltipOptions:a}),this._updateMoveTooltipDistance(n.info,i,ze)}}_updateMoveTooltipDistance(e,t,i){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??ue}}_buildSnappingPipelineSteps(e,t,i,a,n){const s=e.geometry;if(s==null||s.type!=="point"&&s.type!=="mesh")return{steps:i,cancel:a};const o=(s.type==="point"?s:s.anchor).clone(),r=new Pe({elevationInfo:t,pointer:n,editGeometryOperations:je.fromGeometry(o,this.view.state.viewingMode),visualizer:new ge,excludeFeature:e}),l=this.snappingManager,{snappingStep:h,cancelSnapping:u}=Le({snappingContext:r,snappingManager:l,updatingHandles:this.updatingHandles});return a=a.next(u),{steps:i=i.next(d=>(o.z=Gn(this.view,o,V(e),{mode:"absolute-height",offset:0}),{...d,snapOrigin:r.coordinateHelper.pointToVector(o)})).next(...h),cancel:a}}get test(){return{tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],_t.prototype,"view",void 0),p([c()],_t.prototype,"graphics",void 0),p([c({constructOnly:!0,nonNullable:!0})],_t.prototype,"enableZ",void 0),p([c({constructOnly:!0,type:Ct})],_t.prototype,"tooltipOptions",void 0),p([c({constructOnly:!0})],_t.prototype,"snappingManager",void 0),p([c()],_t.prototype,"type",void 0),p([c()],_t.prototype,"updating",null),_t=p([H("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],_t);class Jo{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new J({graphic:t})}get graphic(){return this.state.graphic}}function ga(e,t,i){const a=i.mode==="on-the-ground"?qi.XY:qi.XYZ;return new Hs(e,a,t,0)}function _a(e,t,i){const a=P();if(!e.renderCoordsHelper.toRenderCoords(t,a))return null;const n=ma(e,t,fe(i.plane)),s=ma(e,t,i.edgeDirection);if(n==null||s==null)return null;const o=Jt(P(),n,s);return Ra(a,o,Si())}function ma(e,t,i){const a=me(t.x+i[0],t.y+i[1],t.z+i[2],t.spatialReference),n=P(),s=P();return e.renderCoordsHelper.toRenderCoords(t,n)&&e.renderCoordsHelper.toRenderCoords(a,s)?$a(s,n,s):null}function Ko(e,t,i){const a=fe(e),n=$a(P(),t,i),s=Jt(P(),n,a),o=Jt(P(),n,s);return Rn(n[0],n[1],n[2],0,s[0],s[1],s[2],0,o[0],o[1],o[2],0,0,0,0,1)}function Qo(e,t,i){const a=i.projectToRenderScreen(e,Hi()),n=i.projectToRenderScreen(t,Hi());return a!=null&&n!=null?$n(st(a,a,n)):0}let Rt=class extends Ye{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=ue,this.area=null,this.totalLength=null}};p([c()],Rt.prototype,"type",void 0),p([c()],Rt.prototype,"distance",void 0),p([c()],Rt.prototype,"area",void 0),p([c()],Rt.prototype,"totalLength",void 0),Rt=p([H("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Rt);let I=class extends gt.EventedMixin(wi){constructor(e){super(e),this._selectedIndex=0,this._manipulatorHandles=new te,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=D.NONE,this._recreatingManipulators=!1,this.outputGeometry=null,this._vertexLaserLineVisualElement=null;const t=L(e.tool.view).manipulators,i=t.vertex;this._vertexManipulatorMaterial=bt(G(i.color),i.renderOccluded),this._vertexManipulatorOutlineMaterial=se(G(i.outlineColor),i.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=se(G(i.hoverOutlineColor),i.renderOccluded);const a=t.edge;this._edgeManipulatorMaterial=bt(G(a.color),a.renderOccluded),this._edgeManipulatorOutlineMaterial=se(G(a.outlineColor),a.renderOccluded);const n=t.edgeOffset;this._edgeOffsetManipulatorMaterial=bt(G(n.color),n.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=bt(G(n.hoverColor),n.renderOccluded,!1);const s=t.selected;this._selectedManipulatorMaterial=bt(G(s.color),s.renderOccluded),this._selectedManipulatorOutlineMaterial=se(G(s.outlineColor),s.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=se(G(s.hoverOutlineColor),s.renderOccluded)}initialize(){const{graphic:e,view:t}=this,i=this._graphicState=new J({graphic:e});this._tooltip=new ye({view:t}),this.addHandles([T(()=>i.displaying,a=>{for(const n of this._manipulatorInfos)n.manipulator.available=a}),T(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:n,edgeOffsetEnabled:s})=>{a!=null&&(a.visible=n,a.edgeDistance=s?"far":"default")},$t),kt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),$t),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=$(this._segmentLabels),this._tooltip=$(this._tooltip),this._removeManipulators()}get inputGeometry(){return this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null}set inputGeometry(e){this._recreateEditGeometryAndManipulators(e)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const e=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");this._removeVertices(e)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=$(this._moveManipulation),this._graphicMoveManipulation=$(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(e){if(this._editGeometryOperations==null)return;const t=V(this.graphic);for(const i of this._editGeometryOperations.data.components){const a=e==null?void 0:e.byComponentIndex.get(i.index);for(const n of i.vertices){const s=a==null?void 0:a.has(n.index);this._createVertexOrEdgeManipulator(n,t,s)}for(const n of i.edges)this._createVertexOrEdgeManipulator(n,t)}this._createGraphicMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations!=null&&this._editGeometryOperations.canUndo}redo(){if(this._editGeometryOperations==null)return null;const e=this._editGeometryOperations.redo();return e!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}undo(){if(this._editGeometryOperations==null)return null;this.emit("undo");const e=this._editGeometryOperations.undo();return e!=null&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),e}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(e){const t={byComponentIndex:new Map};if(e!=null&&this.inputGeometry!=null&&In(e,this.inputGeometry)){for(const a of this._manipulatorInfos)if(a.type==="vertex"&&a.manipulator.selected){const{index:n,component:{index:s}}=a.handle,{byComponentIndex:o}=t,r=o.get(s)||new Set;r.add(n),o.set(s,r)}}if(this._recreatingManipulators=!0,this._removeManipulators(),this._tooltip.clear(),this._editGeometryOperations=$(this._editGeometryOperations),this._segmentLabels=$(this._segmentLabels),e==null)return void(this._recreatingManipulators=!1);const i=e.type==="mesh"?e.anchor:e;this._editGeometryOperations=je.fromGeometry(i,this.view.state.viewingMode),this._createManipulators(t),this._segmentLabels=new Ve({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:V(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(e,t){if(t.action==="end")return t;let i=0;const a=[],n=this._manipulatorInfos.some(o=>o.type==="vertex"&&o.manipulator.selected),s=e===jt.SELECTED_OR_ALL&&n;for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.grabbing||s&&!o.manipulator.selected||a.push(o),i++);if(a.length===0)return t;if(this._moveVertices(a,t),a.length===i){if(this._updateEventState(D.MOVING),this.destroyed)return t;this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(D.RESHAPING),this.destroyed)return t;this.emit("reshape",{type:"reshape",mover:this.graphic})}return t}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((e,t)=>t.type==="vertex"&&t.manipulator.selected?e+1:e,0)>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(D.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:i,mapDeltaZ:a}=e;if(!t&&!i&&!a)return;const n=[];for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected&&!s.manipulator.grabbing||s===e.info)&&n.push(s);this._moveVertices(n,e,Mt.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case D.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case D.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case D.MOVING:switch(this._reshapeEventState){case D.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case D.RESHAPING:switch(this._reshapeEventState){case D.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case D.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulation(){const{tool:e,view:t}=this,i=this._graphicState;if(this._graphicMoveManipulation=new Di({tool:e,view:t,graphicState:i}),this.enableMoveGraphic){let a=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((n,s,o)=>{s.next(r=>this._trackNumDragging(r)).next(r=>(r.action==="start"&&(a=this._editGeometryOperations.createUndoGroup()),r)).next(r=>this._perGraphicManipulatorDragAction(jt.ALL,r)).next(r=>(this._updateTranslateGraphicTooltip(y.XY,r),r)).next(r=>{r.action==="end"&&(this._tooltip.clear(),a=Tt(a))}),o.next(()=>this._onDragCancel(!0,()=>a=Tt(a)))})),this._graphicMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(n,!1)))}else this._graphicMoveManipulation.forEachManipulator(a=>{a.grabbable=!1,a.cursor=null});this._graphicMoveManipulation.forEachManipulator(a=>this._manipulatorHandles.add(a.events.on("immediate-click",n=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...n,graphic:this.graphic}),n.stopPropagation()})))}_createMoveManipulation(e){const{graphic:t,handles:i,tool:a,view:n}=this,s=this._graphicState;this._moveManipulation=new Ht({tool:a,view:n,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Vt(t),snapToScene:!1,radius:Ht.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator(l=>i.add([l.events.on("immediate-click",h=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(u=>u.manipulator.selected)||this.emit("immediate-click",{...h,graphic:t}),h.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const o=l=>h=>{i.add(h.events.on("focus-changed",({action:u})=>{u==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(l):this._tooltip.clear()}))};this._moveManipulation.xyManipulation.forEachManipulator(o(y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(o(y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(o(y.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=t.geometry.spatialReference;i.add([this._moveManipulation.createDragPipeline((l,h,u,d,g)=>{const{snappingStep:_,cancelSnapping:m}=Le({predicate:v=>!!v.info,snappingManager:a.snappingManager,snappingContext:new Pe({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:g,excludeFeature:t,visualizer:new ge}),updatingHandles:this.updatingHandles,useZ:!1});return d=d.next(v=>(this._onDragCancel(),v)).next(m),{steps:u=u.next(v=>this._trackNumDragging(v)).next(v=>{const f=this._manipulatorInfos.filter(x=>x.type==="vertex"&&x.manipulator.selected);return v.manipulatorType===A.TRANSLATE_XY&&f.length===1?{...v,info:f[0],snapOrigin:f[0].handle.pos}:v}).next(Wi(this.view,e,t)).next(..._).next(Bt()).next(v=>this._perGraphicManipulatorDragAction(jt.SELECTED_OR_ALL,v)).next(v=>(this._updateTranslateTooltip(l,v),v)),cancel:d}},e,r,t),T(()=>s.displaying,()=>this._updateMoveManipulationPosition(),$t),s.on("changed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),T(()=>s.isDraped,l=>{this._updateMoveManipulationPosition();const h="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),h):i.remove(h)},$t)])}_createVisualElements(){const{graphic:e,view:t}=this,i=qe({view:t,graphic:e,forEachManipulator:a=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a);for(const n of this._manipulatorInfos)a(n.manipulator,A.TRANSLATE_XY)}},onManipulatorsChanged:a=>this.on("manipulators-changed",a)});i!=null&&(this._outlineVisualElement=i.visualElement instanceof Ut?i.visualElement:null),this._outlineVisualElement!=null&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(e,t=V(this.graphic)){var _,m;const i=L(this.view).manipulators.edgeOffset,a=i.size/2,n=a+i.collisionPadding,s=a/n,o=s*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside==null&&(this._edgeOffsetManipulatorGeometryInside=De(this._edgeOffsetManipulatorMaterial,o,s/2,s/2,i.height,i.offset)),this._edgeOffsetManipulatorGeometryOutside==null&&(this._edgeOffsetManipulatorGeometryOutside=De(this._edgeOffsetManipulatorMaterial,-o,s/2,s/2,i.height,-i.offset));const r=[new M(this._edgeOffsetManipulatorGeometryInside.instantiate(),S.Unfocused),new M(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),S.Focused),new M(this._edgeOffsetManipulatorGeometryOutside.instantiate(),S.Unfocused),new M(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),S.Focused)],l=new Q({view:this.view,renderObjects:r,elevationInfo:t.mode!=="on-the-ground"||ki(this.graphic.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:n,available:!(!this.graphic.visible||!((_=this.graphic.layer)!=null&&_.visible)),collisionType:{type:"disc",direction:Z(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new Q({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!((m=this.graphic.layer)!=null&&m.visible)),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),u={manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const d=[];for(const v of[u.handle.leftVertex,u.handle.rightVertex]){const f=this._getManipulatorInfoFromHandle(v);f!=null&&d.push(f.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(u)))}u.locationUpdateHandle=F(d),this._manipulatorHandles.add(u.locationUpdateHandle,l),this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!0),this._watchAndUpdateGrabState(h,!0)],l),this._manipulatorHandles.add(ot(l,this._createEdgeOffsetPipeline(u,t)),l),this._manipulatorHandles.add(ot(h,(v,f,x,O)=>{if(O==="touch")this._createEdgeOffsetPipeline(u,t)(v,f,x);else if(this.enableMoveGraphic){const b=this.graphic,k=b.geometry!=null?b.geometry.spatialReference:null;f.next(X=>this._trackNumDragging(X)).next(pe(this.view,v.elevationAlignedLocation)).next(Oi(this.view,v.elevationAlignedLocation,t,k,b)).next(ee()).next(Bt()).next(X=>this._perGraphicManipulatorDragAction(jt.ALL,X)).next(X=>(this._updateTranslateGraphicTooltip(y.XY,X),X)).next(X=>{X.action==="end"&&this._tooltip.clear()}),x.next(()=>this._onDragCancel(!v.metadata.deleting))}}),l);const g=v=>{this._manipulatorInfos.some(f=>f.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...v,graphic:this.graphic}),v.stopPropagation()};return this._manipulatorHandles.add([l.events.on("immediate-click",g),h.events.on("immediate-click",g),l.events.on("focus-changed",({action:v})=>{const f=this._tooltipOptions;if(v==="focus"&&f.enabled){const x=this._tooltip.info=new Rt({tooltipOptions:f});this._updateTooltipAreaOrTotalLength(x)}else this._tooltip.clear()})],l),this._manipulatorInfos.push(u),this.manipulators.add(l),this.manipulators.add(h),this.emit("manipulators-changed"),u}_autoHideEdgeOffsetManipulator(e,t){const i=e.manipulator,a=e.edgeManipulator,n=()=>{e.visibilityHandle=Tt(e.visibilityHandle);const s=this._getManipulatorInfoFromHandle(e.handle.leftVertex),o=this._getManipulatorInfoFromHandle(e.handle.rightVertex),r=s!=null&&o!=null&&Qo(s.manipulator.renderLocation,o.manipulator.renderLocation,this.view.state.camera)<t;(!i.focused&&!a.focused||r)&&(i.grabbable=!r,a.grabbable=!r,e.visibilityHandle=F([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",n),a.events.on("focus-changed",n),{remove:()=>{Tt(e.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}}],i),n()}_updateEdgeOffsetManipulator(e){this._updateManipulatorPosition(e);const{coordinateHelper:t}=this._editGeometryOperations.data,i=_a(this.view,e.manipulator.elevationAlignedLocation,ga(t,e.handle,e.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(e.handle.leftVertex),n=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(a==null||n==null)return;const s=a.manipulator.renderLocation,o=n.manipulator.renderLocation,r=i!=null?Ko(i,s,o):Cn;e.manipulator.modelTransform=r,e.edgeManipulator.elevationAlignedLocation=e.manipulator.elevationAlignedLocation,e.edgeManipulator.modelTransform=r;const l=Re(st(Oe,s,o))/2;e.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(e,t){return(i,a,n)=>{this._clearSelection();const{step:s,cleanup:o}=this._initializeEdgeOffset(e,t);a.next(r=>this._trackNumDragging(r)).next(pe(this.view,i.elevationAlignedLocation)).next(s).next(Ts(this.view)).next(Ds(this.view,this._editGeometryOperations.data.spatialReference)).next(Bt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(e)).next(this._showEdgeOffsetTooltip()).next(r=>{r.action==="end"&&o()}),n.next(()=>{i.metadata.deleting||(o(),this._onDragCancel())})}}_initializeEdgeOffset(e,t){const{view:i}=this,a=this._editGeometryOperations,n=ga(a.data.coordinateHelper,e.handle,t),s=a.createUndoGroup(),o=_a(i,e.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const _=this._getManipulatorInfoFromHandle(e.handle.leftVertex.leftEdge);_!=null&&this._splitEdgeManipulator(_,1)}if(n.requiresSplitEdgeRight){const _=this._getManipulatorInfoFromHandle(e.handle.rightVertex.rightEdge);_!=null&&this._splitEdgeManipulator(_,0)}const r=()=>new Hn({paths:[[e.handle.leftVertex.pos,e.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),l=L(i),h=new Ut({view:i,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:e.elevationInfo,width:l.visualElements.lineGraphics.outline.width,color:G(l.colors.accent),attached:!0});let u;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(e),u=Tt(u)},g=this.on("undo",d);return u=F([It(h),T(()=>this._graphicState.isDraped,_=>h.isDraped=_),this._graphicState.on("changed",()=>h.geometry=r()),s,g]),{step:_=>n==null||o==null?(d(),null):{..._,operation:n,plane:o},cleanup:d}}_applyEdgeOffsetStep(e){return t=>{if(this.destroyed||t.operation==null)return t;this._updateEventState(D.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:n}=t;return(i||a||n)&&(this._offsetEdge(e,t),this.emit("reshape",{type:"reshape",mover:this.graphic})),t}}_applyComputeEdgeOffsetDistanceStep(){return e=>{const{operation:t,mapEnd:i}=e;return t==null||i==null?e:(e.action==="start"&&t.selectArrowFromStartPoint(i),{...e,signedDistance:t.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return e=>{const{mapEnd:t,signedDistance:i,operation:a}=e,n=this._tooltip,s=this._tooltipOptions;if(!s.enabled||i==null)return n.clear(),e;let o=n.info;o!=null&&o.type==="reshape-edge-offset"||(o=n.info=new Rt({tooltipOptions:s}));const{coordinateHelper:r}=this._editGeometryOperations.data;return o.distance=e.action==="end"?ue:tr(this._graphicState.isDraped,i*a.selectedArrow,t,a.plane,r),this._updateTooltipAreaOrTotalLength(o),e}}_cleanEdgeOffsetCollapsedEdges(e){var r,l;const t=(r=e.handle.leftVertex.leftEdge)==null?void 0:r.leftVertex,i=e.handle.leftVertex,a=(l=e.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,n=e.handle.rightVertex,s=this._editGeometryOperations.data.coordinateHelper,o=[];if(t&&s.distance(t.pos,i.pos)<si){const h=this._getManipulatorInfoFromHandle(i);h!=null&&o.push(h)}if(s.distance(i.pos,n.pos)<si||a&&s.distance(a.pos,n.pos)<si){const h=this._getManipulatorInfoFromHandle(n);h!=null&&o.push(h)}o.length&&this._removeVertices(o)}_computeVertexManipulatorSizeAndOutline(e){const t=e.size/2,i=t+e.collisionPadding;return{size:t/i,outlineSize:(t+e.outlineSize)/i}}_createVertexOrEdgeManipulator(e,t=V(this.graphic),i=!1){var d;const{view:a}=this,n=L(a);if(e.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(e,t);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.vertex);this._vertexManipulatorGeometry=be(this._vertexManipulatorMaterial,g,16,16),this._vertexManipulatorOutlineGeometry=be(this._vertexManipulatorOutlineMaterial,_,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=this._computeVertexManipulatorSizeAndOutline(n.manipulators.edge);this._edgeManipulatorGeometry=be(this._edgeManipulatorMaterial,g,16,16),this._edgeManipulatorOutlineGeometry=be(this._edgeManipulatorOutlineMaterial,_,16,16)}const{geometry:s}=this.graphic,o=s==null?void 0:s.type,r=o==="point"||o==="mesh"?[]:[new M(this._vertexManipulatorGeometry.instantiate(),et.Vertex|S.Unselected),new M(this._vertexManipulatorOutlineGeometry.instantiate(),et.Vertex|S.Unfocused|S.Unselected),new M(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),et.Vertex|S.Focused|S.Unselected),new M(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),S.Selected),new M(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),S.Selected|S.Unfocused),new M(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),S.Selected|S.Focused)];this.enableMidpoints&&r.push(new M(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),et.Edge|S.Focused|S.Unselected),new M(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),et.Edge|S.Focused|S.Unselected),new M(this._edgeManipulatorGeometry.instantiate(),et.Edge|S.Unfocused|S.Unselected),new M(this._edgeManipulatorOutlineGeometry.instantiate(),et.Edge|S.Unfocused|S.Unselected));const l=new Q({view:a,renderObjects:r,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!((d=this.graphic.layer)!=null&&d.visible)),metadata:{deleting:!1}});l.selected=i,this._setTypeSpecificManipulatorSettings(l,e,t);const h=e.type==="edge"?{manipulator:l,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:l,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(l),this._updateManipulatorPosition(h),h.type==="edge"){const g=[];for(const _ of[h.handle.leftVertex,h.handle.rightVertex]){const m=this._getManipulatorInfoFromHandle(_);m!=null&&g.push(m.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(h)))}h.locationUpdateHandle=F(g),this._manipulatorHandles.add(h.locationUpdateHandle,l)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(l,!0),l);const u=ot(l,(g,_,m,v)=>{let f=null;const{snappingStep:x,cancelSnapping:O}=Le({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Pe({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:v,excludeFeature:this.graphic,visualizer:new ge}),updatingHandles:this.updatingHandles,useZ:!1});m=m.next(b=>(this._onDragCancel(!g.metadata.deleting,()=>f=Tt(f)),b)).next(O),_.next(b=>this._trackNumDragging(b)).next(b=>{if(b.action==="start"&&(f=this._editGeometryOperations.createUndoGroup()),h.type==="edge"){const k=this._splitEdgeManipulator(h);return{...b,info:k,snapOrigin:k.handle.pos}}return{...b,info:h,snapOrigin:h.handle.pos}}).next(pe(this.view,g.elevationAlignedLocation)).next(Gs(this.view,this.graphic,g.elevationAlignedLocation,g.location.spatialReference,this.graphic)).next(Wi(this.view,t,this.graphic)).next(...x).next(Bt()).next(b=>{this._perVertexManipulatorDragAction(b),b.action==="end"&&(f=Tt(f)),this._updateTranslateVertexTooltip(g,y.XY,b)})});return this._manipulatorHandles.add([u,l.events.on("immediate-click",g=>this._manipulatorClickCallback(g,h)),l.events.on("select-changed",()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),l.events.on("focus-changed",({action:g})=>{g==="focus"&&h.type!=="edge"?this._updateTranslateVertexTooltip(l,y.XY):this._tooltip.clear()})],l),this.emit("manipulators-changed"),h}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_onDragCancel(e=!0,t){switch(this._numDragging--,e&&(this.undo(),this.outputGeometry=this._editGeometryOperations!=null?this._editGeometryOperations.data.geometry:null),this.tool.snappingManager!=null&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case D.NONE:break;case D.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case D.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(D.NONE)}_setTypeSpecificManipulatorSettings(e,t,i){const{graphic:a,view:n}=this,s=L(n);switch(t.type){case"vertex":{e.state=et.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2;const{size:o,collisionPadding:r}=s.manipulators.vertex;e.radius=o/2+r,e.elevationInfo=i;const{geometry:l}=a,h=l==null?void 0:l.type;e.interactive=h!=null&&h!=="point"&&h!=="mesh";break}case"edge":{e.state=et.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1;const{size:o,collisionPadding:r}=s.manipulators.edge;e.radius=o/2+r,e.elevationInfo=i.mode!=="on-the-ground"||ki(a.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",i=>this._onGrabStateChanged(e,t,i.action,i.pointerType))}_onGrabStateChanged(e,t,i,a="mouse"){if(!this._recreatingManipulators){if(i==="start")t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(D.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(n=>{const{manipulator:s}=n,{geometry:o}=this.graphic,r=o==null?void 0:o.type;s.interactive=s.grabbing||!this._numGrabbing&&r!=null&&r!=="point"&&r!=="mesh","edgeManipulator"in n&&(n.edgeManipulator.interactive=n.edgeManipulator.grabbing||!this._numGrabbing)}),this._graphicMoveManipulation.forEachManipulator(n=>{n.interactive=n.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e!=null&&(e.manipulator.metadata.deleting=!0,this.manipulators.remove(e.manipulator),this._manipulatorHandles.remove(e.manipulator),Pn(this._manipulatorInfos,e),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e){for(const t of this._manipulatorInfos)if(e===t.handle)return t}return null}_updateManipulatorPosition(e){if(e==null)return;const t=this._editGeometryOperations;if(e.type==="vertex")e.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(e.handle.pos,re),e.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if(e.type==="edge"){const i=this._getManipulatorInfoFromHandle(e.handle.leftVertex),a=this._getManipulatorInfoFromHandle(e.handle.rightVertex);if(i==null||a==null)return;const n=i.manipulator,s=a.manipulator;if(e.manipulator.elevationInfo!=null&&e.manipulator.elevationInfo.mode==="on-the-ground"){const o=n.location,r=s.location,l=.5,h=o.x+l*(r.x-o.x),u=o.y+l*(r.y-o.y),d=o.hasZ&&r.hasZ?0:void 0;e.manipulator.location=me(h,u,d,t.data.spatialReference)}else Ln(Oe,n.renderLocation,s.renderLocation,.5),e.manipulator.renderLocation=Oe}}_splitEdgeManipulator(e,t=.5){const i=this._editGeometryOperations,a=i.splitEdge(e.handle,t).createdVertex;e.locationUpdateHandle=Tt(e.locationUpdateHandle);const n=V(this.graphic);let s;this.enableEdgeOffset?(this._removeManipulator(e),s=this._createVertexOrEdgeManipulator(a)):(s=e,s.handle=a,s.type="vertex",this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(s),this.enableEdgeOffset||this._updateTranslateVertexTooltip(s.manipulator,y.XY),this._updateSelection(e.manipulator);const o=this._updateEventState(D.RESHAPING),r=i.data.coordinateHelper.vectorToArray(s.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),o&&this._updateEventState(D.NONE),s}_updateMoveManipulationPosition(){const e=nt(Oe,0,0,0);let t=0,i=!1,a=null,n=null;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.selected?(t++,Ne(e,e,s.manipulator.renderLocation),a==null||s.selectedIndex>a.selectedIndex?(n=a,a=s):(n==null||s.selectedIndex>n.selectedIndex)&&(n=s)):i=!0);if(t===0){const s=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s,this._moveManipulation.zManipulation.available=s&&this.enableZShape&&Vt(this.graphic),this._moveManipulation.angle=Ya(this.graphic.geometry),this._moveManipulation.radius=Ht.radiusForSymbol(this.graphic.symbol)}else{const s=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=s,this._moveManipulation.xyAxisManipulation.available=s,this._moveManipulation.zManipulation.available=s&&this.enableZVertex&&Vt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=s&&t!==1;let o=0;if(a!=null){const r=a.handle.pos,l=n!=null?n.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,h=n==null&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;l&&h?this._moveManipulation.xyAxisManipulation.available=!1:l?o=va(l,r):h&&(o=va(r,h))}this._moveManipulation.angle=o,this._moveManipulation.radius=Za}t!==0&&i?(ve(e,e,1/t),re.spatialReference=this._editGeometryOperations.data.spatialReference,re.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,re),this._moveManipulation.elevationAlignedLocation=re):this._outlineVisualElement==null||this._graphicState.isDraped||this._outlineVisualElement.attachmentOrigin==null?La(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(e){var a;const t=new Array,i=this._editGeometryOperations;for(const n of e)if(n.type==="vertex"&&i.canRemoveVertex()){t.push(n.handle),this._removeManipulator(n),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.rightEdge));const s=i.removeVertices([n.handle]),o=(a=s.removedVertices)==null?void 0:a[0].createdEdge;o&&this._createVertexOrEdgeManipulator(o)}if(t.length>0){const n=t.map(o=>{const r=i.data.components.indexOf(o.component);return{coordinates:i.data.coordinateHelper.vectorToArray(o.pos),componentIndex:r,vertexIndex:o.index}});this.outputGeometry=i.data.geometry;const s=this._updateEventState(D.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:n.map(o=>o.coordinates),vertices:n}),this.destroyed)||s&&(this._updateEventState(D.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(e,t,i=t.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS){const a=this._editGeometryOperations;a.moveVertices(e.map(n=>n.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const n of e)this._updateManipulatorPosition(n)}_offsetEdge(e,t){if(t.operation==null||t.signedDistance==null)return;const i=this._editGeometryOperations,a=t.operation.clone();a.distance=t.signedDistance,i.updateVertices([e.handle.leftVertex,e.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(e.handle.rightVertex))}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,e.button===Ui.Right&&this._removeVertices([t])),t.type==="edge"&&e.button===Ui.Left&&this._splitEdgeManipulator(t),e.stopPropagation()}_updateTranslateTooltip(e,t){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,e,t):this._updateTranslateGraphicTooltip(e,t)}_updateTranslateGraphicTooltip(e,t){const i=this._tooltipOptions;if(!i.enabled)return;const a=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case y.XY:this._tooltip.info=new _e({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(n,s)=>wt(n,s,a));break;case y.XY_AXIS:this._tooltip.info=new Ei({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,(n,s)=>{const o=wt(n,s,a);return Ie(o,ke(t))});break;case y.Z:this._tooltip.info=new We({tooltipOptions:i}),this._updateTranslateTooltipDistance(this._tooltip.info,t,ze)}}_updateTranslateVertexTooltip(e,t,i){const a=this._tooltipOptions;if(!a.enabled)return;let n;const s=this._graphicState.isDraped?"on-the-ground":"absolute-height";switch(t){case y.XY:n=new Ns({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,(r,l)=>wt(r,l,s)),this._updateTooltipAreaOrTotalLength(n);break;case y.XY_AXIS:n=new Us({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,(r,l)=>{const h=wt(r,l,s);return Ie(h,ke(i))}),this._updateTooltipAreaOrTotalLength(n);break;case y.Z:n=new ks({tooltipOptions:a}),this._updateTranslateTooltipDistance(n,i,ze)}const o=Fs(e.elevationAlignedLocation);o!=null&&(n.elevation={mode:"absolute-height",...o}),this._tooltip.info=n}_updateTranslateTooltipDistance(e,t,i){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??ue}}_updateTooltipAreaOrTotalLength(e){const{geometry:t}=this.graphic;if(t==null)return;const i=this._graphicState.isDraped?"on-the-ground":"absolute-height";e.area=t.type==="polygon"?Zs(t,i):null,e.totalLength=t.type==="polyline"?ds(t,i):null}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function va(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function tr(e,t,i,a,n){if(e){const s=n.toXYZ(n.pointToVector(i)),o=zn(a,s,R.get()),r=gs(o,s,n.spatialReference);if(r!=null)return de(r.value*Math.sign(t),r.unit)}return de(t*ui(i.spatialReference),"meters")}p([c()],I.prototype,"_editGeometryOperations",void 0),p([c()],I.prototype,"_segmentLabels",void 0),p([c({constructOnly:!0})],I.prototype,"tool",void 0),p([c()],I.prototype,"_tooltip",void 0),p([c()],I.prototype,"inputGeometry",null),p([c()],I.prototype,"outputGeometry",void 0),p([c({readOnly:!0})],I.prototype,"updating",null),p([c()],I.prototype,"manipulators",null),p([c()],I.prototype,"view",null),p([c()],I.prototype,"graphic",null),p([c()],I.prototype,"enableZShape",null),p([c()],I.prototype,"enableZVertex",null),p([c()],I.prototype,"enableMoveGraphic",null),p([c()],I.prototype,"enableMidpoints",null),p([c()],I.prototype,"enableEdgeOffset",null),p([c()],I.prototype,"_labelOptions",null),p([c()],I.prototype,"_tooltipOptions",null),I=p([H("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],I);const re=me(0,0,void 0,Vn.WGS84),Oe=P(),si=1e-6;var et,D,jt;(function(e){e.Vertex=yt.Custom1,e.Edge=yt.Custom2})(et||(et={})),function(e){e[e.NONE=0]="NONE",e[e.MOVING=1]="MOVING",e[e.RESHAPING=2]="RESHAPING"}(D||(D={})),function(e){e[e.ALL=0]="ALL",e[e.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(jt||(jt={}));let N=class extends gt.EventedMixin(Be){constructor(e){super(e),this._handles=new te,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Ia,this.tooltipOptions=new Ct,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const e=this._reshapeOperation=new I({tool:this});this.addHandles([e.on("reshape",t=>{t.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",t)}),e.on("move",t=>{t.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",t)}),e.on("vertex-add",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)}),e.on("vertex-remove",t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)}),e.on("immediate-click",t=>this.emit("immediate-click",t)),this.view.on("pointer-down",["Shift"],t=>t.stopPropagation()),T(()=>this.graphic,()=>this._updateGraphic(),qt)]),this.finishToolCreation()}destroy(){this._handles=$(this._handles),this._reshapeOperation=$(this._reshapeOperation)}get updating(){var e;return((e=this._reshapeOperation)==null?void 0:e.updating)??!1}_updateGeometry(){const e=kn(this.graphic);this._reshapeOperation.inputGeometry=e!=null?e.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),Un(this.graphic)!==Ga.SUPPORTED)return;const e=T(()=>{var t;return(t=this.graphic)==null?void 0:t.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},$e);this._handles.add(e,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(e){this._internalGeometryUpdate=!0;const{graphic:t}=this,{geometry:i}=t;(i==null?void 0:i.type)==="mesh"&&e.type==="point"?(t.geometry=i.centerAt(e),t.notifyGeometryChanged()):t.geometry=e,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:e}=this._reshapeOperation;this.graphic!=null&&e&&this._updateGeometryInternally(e.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const e=this._reshapeOperation.undo(),{outputGeometry:t}=this._reshapeOperation;e&&t&&this._updateGeometryInternally(t.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){this.snappingManager!=null&&this.snappingManager.doneSnapping();const e=this._reshapeOperation.redo(),{outputGeometry:t}=this._reshapeOperation;e&&t&&this._updateGeometryInternally(t.clone())}onInputEvent(e){e.type!=="key-down"||e.key!=="Delete"&&e.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};p([c()],N.prototype,"_reshapeOperation",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),p([c({constructOnly:!0})],N.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZShape",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableZVertex",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMoveGraphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableMidpoints",void 0),p([c({constructOnly:!0,nonNullable:!0})],N.prototype,"enableEdgeOffset",void 0),p([c()],N.prototype,"type",void 0),p([c({constructOnly:!0,type:Ia})],N.prototype,"labelOptions",void 0),p([c({constructOnly:!0,type:Ct})],N.prototype,"tooltipOptions",void 0),p([c({constructOnly:!0})],N.prototype,"snappingManager",void 0),p([c()],N.prototype,"updating",null),p([c()],N.prototype,"automaticManipulatorSelection",void 0),N=p([H("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],N);let mt=class extends Ye{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};p([c()],mt.prototype,"type",void 0),p([c()],mt.prototype,"rotation",void 0),p([c()],mt.prototype,"rotationPrecision",void 0),p([c()],mt.prototype,"orientation",void 0),p([c()],mt.prototype,"orientationPrecision",void 0),p([c()],mt.prototype,"rotationType",void 0),mt=p([H("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],mt);let Dt=class extends Ye{constructor(e){super(e),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};p([c()],Dt.prototype,"type",void 0),p([c()],Dt.prototype,"scale",void 0),p([c()],Dt.prototype,"size",void 0),p([c()],Dt.prototype,"sizeUnit",void 0),p([c()],Dt.prototype,"sizePrecision",void 0),Dt=p([H("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],Dt);let ct=class extends Ye{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};p([c()],ct.prototype,"type",void 0),p([c()],ct.prototype,"orientation",void 0),p([c()],ct.prototype,"orientationPrecision",void 0),p([c()],ct.prototype,"rotationType",void 0),p([c()],ct.prototype,"size",void 0),p([c()],ct.prototype,"sizePrecision",void 0),p([c()],ct.prototype,"sizeUnit",void 0),ct=p([H("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],ct);var w,Qt;(function(e){e.ScaleIn=yt.Custom2,e.ScaleOut=yt.Custom3,e.RotateLeft=yt.Custom4,e.RotateRight=yt.Custom5,e.Unlocked=yt.Custom7,e.DelayedFocused=yt.Custom8,e.TouchInput=yt.Custom12})(w||(w={}));class er{get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}constructor({adapter:t,tooltipOptions:i,mode:a,tool:n}){this._mode=null,this._handles=new te,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=ko,this.events=new gt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>{var s;return((s=this._scaleRotateDragData)==null?void 0:s.mode)==="scale"?this._adapter.scale:1},this.tool=n,this._mode=a,this._adapter=t,this._tooltipOptions=i,this._tooltip=new ye({view:n.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(kt(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),$t))}destroy(){var t;(t=this._activeAnimation)==null||t.frameTask.remove(),this._activeAnimation=null,this._handles=$(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=$(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const i=Nn({update:({deltaTime:a})=>{t.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:i}}cancelActiveAnimation(){var t;(t=this._activeAnimation)==null||t.frameTask.remove(),this._activeAnimation=$(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,A.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const i=this.tool.graphicState.graphic,a=ot(t,(n,s,o)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:he(n.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const h=R.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(n.renderLocation,h),s.next(_i(this.tool.view,Ra(n.renderLocation,h,Si()))).next(u=>{const d=fe(u.plane),g=za(u.renderStart,u.renderEnd,l.origin,d),_=Fn.shortestSignedDiff(l.angle,g);l.angleDir=ci(l.angleDir+_,-pa,pa),l.angle=g;const m=ir(l,u),v=m-this._adapter.scale;if(l.scaleDir=ci(l.scaleDir+v,-ha,ha),this._onScaleChanged(),l.mode==="none"){const f=this._mode||ar(u,u.plane,l.origin,this.tool.view.state.camera);if(f!=null){switch(f){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=f}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+g;break;case"scale":r.state.scale=m,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),u.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:ce(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:m,yScale:m})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:ce(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:m,yScale:m})}}return u.action==="end"&&(this.startAnimation(fa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),r.done()),u}).next(this._updateTooltipPipelineStep(l)),o.next(()=>{if(r.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(fa(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,t.events.on("focus-changed",n=>{n.action==="focus"?this.startAnimation(nr(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),t.events.on("immediate-click",n=>{n.stopPropagation()}),T(()=>{var n;return(n=this.tool.graphicState)==null?void 0:n.displaying},n=>this._ringManipulator.available=n,$t)])}_updateTooltipPipelineStep(t){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const n=this._tooltip,s=this._tooltipOptions.visualVariables;switch(t.mode){case"scale":{const{size:o,scale:r}=this._adapter,l=s==null?void 0:s.size;n.info=new Dt({tooltipOptions:a,scale:{value:r},size:o!=null?de(o,"meters"):void 0,sizePrecision:Ae(l==null?void 0:l.valueType),sizeUnit:l==null?void 0:l.unit});break}case"rotate":{const{orientationClockwise:o,relativeAngleClockwise:r}=this._adapter,l=s==null?void 0:s.rotation,h=Ae(l==null?void 0:l.valueType);n.info=new mt({tooltipOptions:a,rotation:r!=null?ei(r,"radians","geographic"):void 0,rotationPrecision:h,rotationType:(l==null?void 0:l.rotationType)??"geographic",orientation:o!=null?ei(o,"radians","geographic"):void 0,orientationPrecision:h})}}return i}}_updateFocusTooltip(){if(this._tooltipOptions.enabled)if(this.getFocused()){const t=this._tooltipOptions.visualVariables,i=t==null?void 0:t.rotation,a=t==null?void 0:t.size,n=this._mode,{size:s,orientationClockwise:o}=this._adapter,r=o!=null&&(n==null||n==="rotate"),l=s!=null&&(n==null||n==="scale");this._tooltip.info=new ct({tooltipOptions:this._tooltipOptions,orientation:r?ei(o,"radians","geographic"):void 0,orientationPrecision:Ae(i==null?void 0:i.valueType),rotationType:(i==null?void 0:i.rotationType)??"geographic",size:l?de(s,"meters"):void 0,sizeUnit:a==null?void 0:a.unit,sizePrecision:Ae(a==null?void 0:a.valueType)})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(w.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){var t;if(this._ringManipulator.updateStateEnabled(w.Unlocked,!(this._scaleRotateDragData!=null&&((t=this._scaleRotateDragData)==null?void 0:t.mode)!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(w.ScaleIn|w.ScaleOut,!1),this._ringManipulator.updateStateEnabled(w.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(w.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(w.RotateLeft|w.RotateRight,!1),this._ringManipulator.updateStateEnabled(w.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(w.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(w.ScaleIn|w.ScaleOut|w.RotateLeft|w.RotateRight,!1)}_updateManipulatorTransform(){const t=Aa(q.get(),this._adapter.angle,Z(0,0,1));if(t==null)return;const i=this.getScale(),a=Ge(q.get(),nt(R.get(),i,i,i));this._ringManipulator.modelTransform=Te(q.get(),a,t)}_createRingManipulator(){const t=(E,K,lt)=>{const Et=[],At=Math.ceil(Fa*(K-E)/(2*Math.PI));for(let U=0;U<At+1;U++){const ae=E+U*(K-E)/At;Et.push(Z(lt*Math.cos(ae),lt*Math.sin(ae),0))}return Et},i=E=>t(0,2*Math.PI,E),a=E=>[[-E/2,0],[E/2,0],[E/2,ai/2],[-E/2,ai/2]],n=this._createMaterial(1),s=(E,K,lt=n)=>Xn(lt,a(K),E,[],[],!1),o=i(zt),r=s(o,ni),l={left:new Array,right:new Array},h=[];for(let E=0;E<2;E++){const K=E*Math.PI-Math.PI/4,lt=Math.PI/2-Vo,Et=K+lt,At=K+Math.PI/2-lt,U=t(Et,At,Po),ae=s(U,Zt);h.push(U),h.push(t(Et,At,na-ni/2)),l.left.push(ae),l.right.push(ae.instantiate());for(let Ke=0;Ke<2;Ke++){const Gi=Ke===0,Y=Ze();if(Gi){Ta(Y,Y,[1,-1,1]),Ni(Y,Y,-Et,[0,0,1]);const Pt=Math.round(oa*(U.length-1));Y[12]=U[Pt][0],Y[13]=U[Pt][1],Y[14]=U[Pt][2]}else{Ni(Y,Y,At,[0,0,1]);const Pt=Math.round((1-oa)*(U.length-1));Y[12]=U[Pt][0],Y[13]=U[Pt][1],Y[14]=U[Pt][2]}const Ri=De(n,Lo,0,zo,ai);Ea(Ri,Y),(Gi?l.left:l.right).push(Ri)}}const u=[];for(let E=0;E<2;E++){const K=E*Math.PI-Math.PI/4,lt=Math.PI/2-Ho,Et=K+lt,At=K+Math.PI/2-lt,U=t(Et,At,na);u.push(s(U,Zt))}const d=this._createMaterial(.66),g=this._createMaterial(.5),_=this._createMaterial(.33),m=i(zt+ra),v=i(zt+la),f=s(m,Zt,d),x=s(v,Zt,_),O=i(zt-ra),b=i(zt-la),k=s(O,Zt,d),X=s(b,Zt,_);let Ot=[new M(r,w.DelayedFocused),new M(r.instantiate({material:g}),S.None)];this._mode&&this._mode!=="scale"||(Ot=Ot.concat([...u.map(E=>new M(E,w.DelayedFocused|w.Unlocked)),new M(f,w.DelayedFocused|w.ScaleIn),new M(x,w.DelayedFocused|w.ScaleIn),new M(k,w.DelayedFocused|w.ScaleOut),new M(X,w.DelayedFocused|w.ScaleOut)])),this._mode&&this._mode!=="rotate"||(Ot=Ot.concat([...l.right.map(E=>new M(E.instantiate(),w.DelayedFocused|w.Unlocked)),...l.left.map(E=>new M(E,w.DelayedFocused|w.RotateLeft)),...l.right.map(E=>new M(E,w.DelayedFocused|w.RotateRight))]));const ie=[o,...h];return new Q({view:this.tool.view,renderObjects:Ot,autoScaleRenderObjects:!1,worldOriented:!0,radius:ni,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:V(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:ie,direction:Z(0,0,1)}})}_createMaterial(t){const i=L(this.tool.view).colors.accent.clone();return i.a=t,new Mi({color:G(i),transparent:t!==1,cullFace:bi.Back,renderOccluded:z.Transparent})}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}}function ir(e,t){const i=st(R.get(),t.renderStart,e.origin),a=st(R.get(),t.renderEnd,e.origin),n=Re(i),s=Re(a);return n===0?0:s/n}function ar(e,t,i,a){const{renderStart:n,renderEnd:s}=e,o=Ee(n,a,R.get()),r=Ee(s,a,R.get());if(Zn(o,r)<sa*sa)return null;const l=st(R.get(),n,i),h=Jt(R.get(),l,fe(t)),u=n,d=Ne(R.get(),u,h),g=Ee(i,a,R.get()),_=o,m=Ee(d,a,R.get()),v=st(R.get(),m,_),f=st(R.get(),o,g),x=Fi(_,v),O=Fi(g,f);return Xi(x,r)<Xi(O,r)?"rotate":"scale"}function Ee(e,t,i){return t.projectToScreen(e,oi),nt(i,oi[0],oi[1],0)}function fa(e,t){let i=null,a=1;const n=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=n,t()},update:s=>(a+=((a+1)/2-a)*Math.min(s*Uo,1),t(),Math.abs(a-1)<.01?Qt.STOP:Qt.CONTINUE),destroy:()=>{i&&(e.getScale=i),t()}}}function nr(e,t,i){let a=0,n=null;const s=()=>!1;return{start:()=>{n=e.getFocused,e.getFocused=s,a=0,t()},update:o=>(a+=o,!(n!=null&&n())||a>=i.delayMs?Qt.STOP:Qt.CONTINUE),destroy:()=>{n&&(e.getFocused=n),t()}}}function Ae(e){switch(e){case"integer":case"long":return 0;default:return null}}(function(e){e[e.CONTINUE=0]="CONTINUE",e[e.STOP=1]="STOP"})(Qt||(Qt={}));const oi=Ue();function Ba(e){return e.geometry!=null&&e.geometry.type==="mesh"?sr(e.geometry):or(e)}function sr(e){return e.vertexSpace.isRelative?rr(e,e.transform,e.vertexSpace):lr(e)}function or(e){let t=e.geometry,i=null;return{undo(a){i=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=i}}}function rr(e,t,i){let a=t==null?void 0:t.clone(),n=he(i.origin),s=null,o=null;return{undo:r=>{var l;s=(l=e.transform)==null?void 0:l.clone(),o=he(i.origin),e.transform=a,e.vertexSpace.origin=n,r.notifyMeshTransformChanged()},redo:r=>{var l;a=(l=e.transform)==null?void 0:l.clone(),n=he(i.origin),e.transform=s,e.vertexSpace.origin=o,r.notifyMeshTransformChanged()}}}function lr(e){let t,i=e.vertexAttributes.clonePositional();return{undo:a=>{t=e.vertexAttributes.clonePositional(),e.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=e.vertexAttributes.clonePositional(),e.vertexAttributes=t,a.notifyGeometryChanged()}}}let W=class extends wi{constructor(e){super(e),this._interactionState=null}initialize(){this.addHandles([kt(()=>{const e=this._interactionState;return e&&e.angle!==e.previousAngle?{interactionState:e,angle:e.state.angle}:null},({interactionState:e})=>{this._updateMeshRotation(e)},$e),kt(()=>{const e=this._interactionState;return e&&e.scale!==e.previousScale?{interactionState:e,scale:e.state.scale}:null},({interactionState:e})=>{this._updateMeshSize(e)},$e)])}get initialAngle(){var e;return((e=this._interactionState)==null?void 0:e.initialAngle)??0}get angle(){var i;const e=this.geometry.transform;if(e==null)return((i=this._interactionState)==null?void 0:i.angle)??0;const t=Bn(e.rotation)[2];return Math.abs(t)>.999999?Xe(jn(e.rotation))*Math.sign(t):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var e;return((e=this._interactionState)==null?void 0:e.scale)??1}startInteraction(){const e=new vt({angle:this.angle});this._interactionState=e;const t=()=>{this._interactionState=null};return{state:e,done:t,cancel:()=>{e.cancel(),t()}}}createUndoRecord(){return Ba(this.graphic)}_updateMeshRotation(e){const{angle:t,previousAngle:i}=e;e.previousAngle=t;const{geometry:a}=this,{vertexSpace:n}=a,s=ce(t-i);if(n.isGeoreferenced){const o=!n.isRelative&&this.viewingMode===di.Global,r=this.geometry.anchor;this.geometry.rotate(0,0,s,{origin:r,geographic:o}),this.graphic.notifyGeometryChanged()}else{a.transform??(a.transform=new Ki);const{transform:o}=a,r=Wn(0,0,s,hr);o.rotation=qn(o.rotation,r,o.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(e){const{scale:t,previousScale:i}=e;e.previousScale=t;const{geometry:a}=this,{vertexSpace:n}=a,s=t/i;if(n.isGeoreferenced){const o=!n.isRelative&&this.viewingMode===di.Global,r=this.geometry.anchor;this.geometry.scale(s,{origin:r,geographic:o}),this.graphic.notifyGeometryChanged()}else{a.transform??(a.transform=new Ki);const{transform:o}=a;o.scale=ve(o.scale,o.scale,s),this.graphic.notifyMeshTransformChanged()}}};p([c({constructOnly:!0})],W.prototype,"graphic",void 0),p([c({constructOnly:!0})],W.prototype,"geometry",void 0),p([c({constructOnly:!0})],W.prototype,"viewingMode",void 0),p([c()],W.prototype,"initialAngle",null),p([c()],W.prototype,"angle",null),p([c()],W.prototype,"angleClockwise",null),p([c()],W.prototype,"relativeAngle",null),p([c()],W.prototype,"relativeAngleClockwise",null),p([c()],W.prototype,"scale",null),p([c()],W.prototype,"_interactionState",void 0),W=p([H("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],W);let vt=class extends fi{get state(){const{angle:e,scale:t}=this;return{angle:e,scale:t}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=e.angle,this.previousAngle=e.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};p([c()],vt.prototype,"angle",void 0),p([c()],vt.prototype,"initialAngle",void 0),p([c()],vt.prototype,"previousAngle",void 0),p([c()],vt.prototype,"previousScale",void 0),p([c()],vt.prototype,"scale",void 0),p([c()],vt.prototype,"state",null),vt=p([H("InteractionState")],vt);const hr=Yn();let C=class extends wi{constructor(e){super(e),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(kt(()=>this._interactionState!=null?this._interactionState.state:null,e=>{this._updateSymbol(e)},$e))}get initialAngle(){var e;return((e=this._interactionState)==null?void 0:e.initialAngle)??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?pr(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var e;return((e=this._interactionState)==null?void 0:e.scale)??1}get size(){const e=this._sizeReferenceSymbolLayer;if(e==null)return null;const t=this.findLayerView(),i=this._graphicSymbol;if(t==null||i==null||i.type!=="point-3d")return null;const a=t.getSymbolLayerSize(i,e);if("size"in a&&a.size!=null)return a.size;const n=this.sizeAxis;return!("width"in a)||a.width==null||n!=null&&n!=="width"&&n!=="all"&&n!=="width-and-depth"?!("depth"in a)||e.depth==null||n!=null&&n!=="depth"&&n!=="all"&&n!=="width-and-depth"?!("height"in a)||e.height==null||n!=null&&n!=="height"&&n!=="all"?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object")}get _orientationReferenceSymbolLayer(){const e=this._graphicSymbol;return e==null||e.symbolLayers.length===0?null:e.symbolLayers.find(t=>t.type==="object"&&t.heading!=null)}get _graphicSymbol(){return this.graphic!=null&&this.graphic.symbol!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(e){this.graphic.symbol=e}startInteraction(){const e=this._graphicSymbol,t=this.findLayerView();if(this._interactionState!=null||e==null||t==null)return cr;const i=e.symbolLayers.map(r=>r.type==="object"?t.getSymbolLayerSize(e,r):null).toArray(),a=e.clone(),n=this.angle,s=new ft({originalSymbol:a,angle:n,initialSizes:i});this._interactionState=s;const o=()=>{this._interactionState=null};return{state:s,done:o,cancel:()=>{this._graphicSymbol=a,o()}}}createUndoRecord(){let e=this.graphic.symbol,t=null;return{undo:i=>{t=i.symbol,i.symbol=e},redo:i=>{e=i.symbol,i.symbol=t}}}_updateSymbol({scale:e,angle:t,originalSymbol:i,initialSizes:a}){const n=this._graphicSymbol;if(n==null||n.type!=="point-3d")return;const s=n.clone(),o=-ce(t-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,s,(l,h,u)=>{const d=(l.heading??0)+o;h.heading!==d&&(h.heading=d,r=!0);const g=a[u];if(g!=null&&"width"in g){g.width=this.sizeFilter(g.width),g.height=this.sizeFilter(g.height),g.depth=this.sizeFilter(g.depth);const _=g.width*e;h.width!==_&&(h.width=_,r=!0);const m=g.depth*e;h.depth!==m&&(h.depth=m,r=!0);const v=g.height*e;h.height!==v&&(h.height=v,r=!0)}}),r&&(this._graphicSymbol=s)}_forEachObjectSymbolLayerPair(e,t,i){e.symbolLayers.forEach((a,n)=>{const s=t.symbolLayers.at(n);a.type==="object"&&s.type==="object"&&i(a,s,n)})}};function pr(e){return-Xe(e)}p([c()],C.prototype,"initialAngle",null),p([c()],C.prototype,"angle",null),p([c()],C.prototype,"angleClockwise",null),p([c()],C.prototype,"orientation",null),p([c()],C.prototype,"orientationClockwise",null),p([c()],C.prototype,"relativeAngle",null),p([c()],C.prototype,"relativeAngleClockwise",null),p([c()],C.prototype,"scale",null),p([c()],C.prototype,"size",null),p([c()],C.prototype,"sizeAxis",void 0),p([c({constructOnly:!0})],C.prototype,"graphic",void 0),p([c()],C.prototype,"_interactionState",void 0),p([c({constructOnly:!0})],C.prototype,"findLayerView",void 0),p([c({constructOnly:!0})],C.prototype,"sizeFilter",void 0),p([c()],C.prototype,"_sizeReferenceSymbolLayer",null),p([c()],C.prototype,"_orientationReferenceSymbolLayer",null),p([c()],C.prototype,"_graphicSymbol",null),C=p([H("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],C);const cr={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let ft=class extends fi{get state(){const{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:n}=this;return{originalSymbol:e,angle:t,initialAngle:i,scale:a,initialSizes:n}}constructor(e){super(e),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=e.angle}};p([c()],ft.prototype,"originalSymbol",void 0),p([c()],ft.prototype,"angle",void 0),p([c()],ft.prototype,"initialAngle",void 0),p([c()],ft.prototype,"initialSizes",void 0),p([c()],ft.prototype,"scale",void 0),p([c()],ft.prototype,"state",null),ft=p([H("InteractionState")],ft);let B=class extends Da(gt.EventedMixin(Be)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Ct,this.type="transform-3d",this._scaleRotate=null,this._tooltip=null}initialize(){const{graphic:e,view:t}=this;this.graphicState=new J({graphic:e}),this.addHandles(T(()=>this.tooltipOptions.enabled,s=>{this._tooltip=s?new ye({view:t}):$(this._tooltip)},qt)),this._moveManipulation=new Ht({tool:this,view:t,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Vt(e),radius:Ht.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator(s=>this.handles.add(s.events.on("immediate-click",o=>{this.emit("immediate-click",{...o,graphic:e}),o.stopPropagation()})));const i=s=>o=>{this.handles.add(o.events.on("focus-changed",({action:r})=>{const l=this._tooltip;l!=null&&(r==="focus"?this._updateMoveTooltip(s):l.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(i(y.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(y.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(y.Z));const a=V(e);this._moveManipulation.elevationInfo=a,this.addHandles(Ai(this.graphicState));const{geometry:n}=e;if(this._moveManipulation.createGraphicDragPipeline((s,o,r,l,h)=>{if(n!=null&&s===y.XY){const{snappingStep:u,cancelSnapping:d}=Le({snappingContext:new Pe({elevationInfo:a,pointer:h,editGeometryOperations:je.fromGeometry(new Jn({spatialReference:n.spatialReference}),t.state.viewingMode),visualizer:new ge,excludeFeature:e}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,useZ:!1});l=l.next(d),r=r.next(zs(this.view,a)).next(...u)}return{steps:r=r.next(u=>(this._updateMoveTooltip(s,u),u)),cancel:l}},this.graphicState,s=>{const{action:o,graphic:r,dxScreen:l,dyScreen:h}=s,u={graphic:r,dxScreen:l,dyScreen:h};switch(o){case"start":this.emit("graphic-translate-start",u),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",u);break;case"end":this.emit("graphic-translate-stop",u)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(T(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const s=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new er({tool:this,mode:s,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([qe({view:this.view,graphic:this.graphic,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>ut()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),T(()=>t.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(s=>{s instanceof Q&&this.handles.add(s.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=$(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=$(this._scaleRotate),this._scaleRotateAdapter=$(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){var e,t,i;return this.graphic.geometry!=null&&this.graphic.geometry.type==="mesh"?new W({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new C({graphic:this.graphic,sizeFilter:a=>this._enforceNonZeroSize(a),findLayerView:()=>this.view.allLayerViews.find(a=>a.layer===this.graphic.layer),sizeAxis:((i=(t=(e=this.tooltipOptions)==null?void 0:e.visualVariables)==null?void 0:t.size)==null?void 0:i.axis)??null})}_forEachManipulator(e){var t,i;(t=this._moveManipulation)==null||t.forEachManipulator(e),(i=this._scaleRotate)==null||i.forEachManipulator(e)}_hideManipulatorsForGraphicState(){return T(()=>this.graphicState.displaying,e=>{this._forEachManipulator(t=>t.available=e),this._moveManipulation.zManipulation.available=e&&this.enableZ&&Vt(this.graphic)})}_createGeometryUndoRecord(){return Ba(this.graphic)}set snapToScene(e){this._moveManipulation&&(this._moveManipulation.snapToScene=e),this._set("snapToScene",e)}get updating(){return this.updatingHandles.updating}set location(e){this._moveManipulation.location=e,this._scaleRotate&&(this._scaleRotate.location=e)}set elevationAlignedLocation(e){this._moveManipulation.elevationAlignedLocation=e,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=e)}reset(){}onHide(){var e;(e=this._scaleRotate)==null||e.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===di.Local||this.view.scale<No?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){La(this.view,this,this.graphic)}_enforceNonZeroSize(e){return e||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(e,t){const{tooltipOptions:i,_tooltip:a}=this;if(a==null)return;a.clear();const n=this.graphicState.isDraped?"on-the-ground":"absolute-height";switch(e){case y.XY:a.info=new _e({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,(s,o)=>wt(s,o,n));break;case y.XY_AXIS:a.info=new Ei({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,(s,o)=>{const r=wt(s,o,n);return Ie(r,ke(t))});break;case y.Z:a.info=new We({tooltipOptions:i}),this._updateMoveTooltipDistance(a.info,t,ze)}}_updateMoveTooltipDistance(e,t,i){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,s=i(a,n);e.distance=s??ue}}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:this._scaleRotate!=null?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:e=>this._scaleRotate!=null?this._scaleRotate.test.setRingIndicatorDelayMs(e):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],B.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],B.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],B.prototype,"enableZ",void 0),p([c()],B.prototype,"enableRotation",void 0),p([c()],B.prototype,"enableScaling",void 0),p([c({constructOnly:!0,type:Ct})],B.prototype,"tooltipOptions",void 0),p([c()],B.prototype,"graphicState",void 0),p([c({value:!1})],B.prototype,"snapToScene",null),p([c({constructOnly:!0})],B.prototype,"snappingManager",void 0),p([c({readOnly:!0})],B.prototype,"type",void 0),p([c({readOnly:!0})],B.prototype,"updating",null),B=p([H("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],B);class ur{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const i={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(i),this._next.execute(i)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new Ha;return this._next=t,[i=>(this._lastDragEvent=i.action!=="end"?{...i}:null,this._enabled&&this._adjustScaleFactors(i),i),t]}_adjustScaleFactors(t){const i=ka(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):t.handle.direction[0]===0?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-i:i,t.factor2=t.factor2<0?-i:i}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let j=class extends gt.EventedMixin(Be){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Ct,this._preserveAspectRatio=new ur,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this._handles=new te,this._attachmentOrigin=null,this._outlineVisualElement=null,this._mapBounds=Se(),this._mapBoundsStart=Se(),this._zmax=0,this._sizeStart=null,this._displayBounds=Se(),this._displayBoundsStart=Se(),this._displayBoundsMarginStart=0,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=le(),this._endScale=le()}initialize(){var g;const{view:e,graphic:t,manipulators:i,_handles:a}=this,n=L(e).colors,s=this._graphicState=new J({graphic:t}),o=t.geometry;this._editGeometryOperations=je.fromGeometry(o,e.state.viewingMode),this._graphicMoveManipulation=new Di({tool:this,view:e,graphicState:s}),this._moveZManipulator=Ys(e,{offsetMode:Bs.CENTER_ON_CALLOUT,calloutColor:n.accent,color:n.contrast,outlineColor:n.accent}),this._moveZManipulator.state|=js,a.add([this._createMoveXYGraphicDragPipeline(),T(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._moveZManipulator,A.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this._moveZManipulator),this._resizeManipulators=this._resizeHandles.map(_=>{const m=Ws(e,_,{color:n.accent});return a.add([T(()=>this.enableScaling,()=>this._updateManipulatorAvailability(m,A.SCALE)),m.events.on("grab-changed",v=>this._onResizeGrab(v)),this._createResizeDragPipeline(m,_)]),m}),i.addMany(this._resizeManipulators);const r=!((g=this.view._stage)!=null&&g.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._rotateManipulatorTexture=Rs(e.toolViewManager.textures,{accentColor:Kt(n.accent,.5),contrastColor:n.contrast,preMultiplyAlpha:r}),this._rotateManipulator=Es(e,{calloutColor:G(n.accent),texture:this._rotateManipulatorTexture.texture}),a.add([T(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._rotateManipulator,A.ROTATE)),this._rotateManipulator.events.on("grab-changed",_=>{this._onRotateGrab(_)}),this._createRotateDragPipeline(this._rotateManipulator)]),i.add(this._rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const l=qe({view:e,graphic:t,forEachManipulator:_=>this._forEachManipulator(_),onManipulatorsChanged:()=>ut()});l!=null&&(this._outlineVisualElement=l.visualElement instanceof Ut?l.visualElement:null),this._outlineVisualElement!=null&&a.add(this._outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(l),a.add([s.on("changed",()=>this._onGeometryChanged()),T(()=>s.displaying,()=>this._updateAllManipulatorAvailability()),T(()=>s.isDraped,()=>this._graphicDrapedChanged(),$t),e.trackGraphicState(s)]);const h=e.pointsOfInterest;a.add(T(()=>h==null?void 0:h.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const u=_=>{a.add(_.events.on("grab-changed",()=>{this.grabbing=_.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(u);const d=(_,m)=>{a.add(_.events.on("immediate-click",v=>{m===A.TRANSLATE_XY&&this.emit("immediate-click",{...v,graphic:t}),v.stopPropagation()}))};this._forEachManipulator(d),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._mapBounds=null,this._displayBounds=null,this._rotateManipulatorTexture.release(),this._handles.destroy(),this._graphicMoveManipulation.destroy(),this._editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{_handles:e,view:t}=this,i=this._tooltip=new ye({view:t}),a=()=>{i.info=this._getUpdatedTooltipInfo()};e.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",n=>{this._startAngle=n.angle,a()}),this.on("graphic-rotate",n=>{this._endAngle=n.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",n=>{Gt(this._startScale,n.xScale,n.yScale),Gt(this._endScale,n.xScale,n.yScale),a()}),this.on("graphic-scale",n=>{Gt(this._endScale,n.xScale,n.yScale),a()}),this.on("graphic-scale-stop",()=>{Gt(this._startScale,0,0),Gt(this._endScale,0,0),a()})]),this._forEachManipulator(n=>{e.add([n.events.on("focus-changed",a),n.events.on("grab-changed",a),n.events.on("drag",s=>{s.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this._graphicMoveManipulation.grabbing||this._graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this._moveZManipulator.focused?this._computeMoveZTooltipInfo():this._rotateManipulator.focused?this._computeRotateTooltipInfo():this._resizeManipulators.some(e=>e.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo??(this._moveXYTooltipInfo=new _e({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const e=this._moveZTooltipInfo??(this._moveZTooltipInfo=new We({tooltipOptions:this.tooltipOptions})),t=this._moveUnit;if(this._moveZManipulator.dragging){const i=this._mapBoundsStart.origin,a=this._mapBounds.origin,n=Xs(i,a,this.view.spatialReference);if(n==null)return null;e.distance=n}else e.distance=de(0,t);return e}_computeRotateTooltipInfo(){const e=this._rotateTooltipInfo??(this._rotateTooltipInfo=new ao({tooltipOptions:this.tooltipOptions}));return e.angle=this._startAngle-this._endAngle,e}_computeScaleTooltipInfo(){const e=this.graphic.geometry;if(e==null)return null;const t=this._scaleTooltipInfo??(this._scaleTooltipInfo=new no({tooltipOptions:this.tooltipOptions})),i=Bi(this._mapBounds,this._zmax,e.spatialReference,this._graphicState.isDraped);return i==null?null:(t.xSize=i[0],t.ySize=i[1],this._sizeStart!=null&&this._resizeManipulators.some(a=>a.dragging)?(t.xScale=i[0].value/this._sizeStart[0].value,t.yScale=i[1].value/this._sizeStart[1].value):(t.xScale=1,t.yScale=1),t)}_graphicDrapedChanged(){this._handles.remove(ya),this._updateDisplayBounds(),this._graphicState.isDraped&&this._handles.add(this.view.elevationProvider.on("elevation-change",e=>{this._attachmentOrigin!=null&&Oa(e.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._updateDisplayBounds()}),ya)}_updateAllManipulatorAvailability(){this._forEachManipulator((e,t)=>this._updateManipulatorAvailability(e,t))}_updateManipulatorAvailability(e,t){const i=this.grabbing&&!e.grabbing;if(e.interactive=!i,e instanceof Q){const a=this._graphicState.displaying,n=this.enableZ&&Vt(this.graphic);switch(t){case A.ROTATE:e.available=a&&this.enableRotation;break;case A.SCALE:e.available=a&&(this.enableScaling||this.enableRotation||n),e.interactive=!i&&this.enableScaling,e.state=this.enableScaling?qs:Js;break;case A.TRANSLATE_Z:e.available=a&&n;break;default:e.available=a}}}_forEachManipulator(e){this._graphicMoveManipulation.forEachManipulator(e),this._resizeManipulators.forEach(t=>e(t,A.SCALE)),e(this._rotateManipulator,A.ROTATE),e(this._moveZManipulator,A.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(e){this._preserveAspectRatio.enabled=e,this._set("preserveAspectRatio",e)}get _moveUnit(){return Kn(this.view.spatialReference)??"meters"}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){var l;const e=this.graphic.geometry,t=this._editGeometryOperations.data,i=t.components[0].edges[0],a=Qn(ts.get(),i.leftVertex.pos,i.rightVertex.pos);ri(a,a);const n=gi(this.view,this.graphic)??((l=e.extent)==null?void 0:l.center);let s=n?gr*this.view.pixelSizeAt(n):0;const o=this.view.spatialReference,r=e.spatialReference;o.equals(r)||(s*=ui(o)/ui(r)),xs(a,t,s,this._mapBounds),this._updateZMax()}_updateZMax(){const e=this._editGeometryOperations.data;if(!e.geometry.hasZ)return void(this._zmax=0);const t=e.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of e.components)for(const n of a.vertices){const s=t.getZ(n.pos)??0;i=Math.max(s,i)}this._zmax=i}_updateDisplayBounds(){const{geometry:e}=this.graphic;if(e==null)return;const{extent:t}=e;if(!t)return;const i=this._outlineVisualElement==null||this._graphicState.isDraped||this._outlineVisualElement.attachmentOrigin==null?gi(this.view,this.graphic):this._outlineVisualElement.attachmentOrigin;this._attachmentOrigin=i??t.center;const a=i!=null?i.z:yi(this._mapBounds.origin,this.view.elevationProvider,Fe.fromElevationInfo(V(this.graphic)),this.view.renderCoordsHelper),n=ne(this._mapBounds);n.origin[2]=a??0,Os(n,this.view.renderCoordsHelper,e.spatialReference,this._displayBoundsMargin,this._displayBounds),this._updateManipulators()}get _displayBoundsMargin(){var i;const e=this.view.pointsOfInterest,t=e?e.centerOnSurfaceFrequent.location:(i=this._editGeometryOperations.data.geometry.extent)==null?void 0:i.center;return t?dr*this.view.pixelSizeAt(t):0}_createMoveXYGraphicDragPipeline(){return this._graphicMoveManipulation.createDragPipeline((e,t,i)=>this._applyGraphicMoveSteps(t,i,y.XY))}_createMoveZDragPipeline(){const e=this.view,t=this._editGeometryOperations.data.spatialReference;return ot(this._moveZManipulator,(i,a,n)=>{const s=he(i.renderLocation),o=a.next(Va(e,s,t)).next(ee());this._applyGraphicMoveSteps(o,n,y.Z)})}_applyGraphicMoveSteps(e,t,i){const a=e.next(n=>(n.action==="start"&&(this.inputState={type:"move"},this._updateOperationStartProperties(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:n.screenDeltaX,dyScreen:n.screenDeltaY})),n)).next(Bt()).next(this._moveDragUpdateGeometry()).next(n=>{const s={graphic:this.graphic,dxScreen:n.screenDeltaX,dyScreen:n.screenDeltaY};switch(n.action){case"start":case"update":(n.mapEnd.x-n.mapStart.x||n.mapEnd.y-n.mapStart.y||(n.mapEnd.z??0)-(n.mapStart.z??0))&&this.emit("graphic-translate",s);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",s)}return n}).next(n=>this._updateMoveTooltip(n,i));return t.next(()=>{this.inputState!=null&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_updateOperationStartProperties(){ne(this._displayBounds,this._displayBoundsStart),ne(this._mapBounds,this._mapBoundsStart),this.graphic.geometry!=null?this._sizeStart=Bi(this._mapBoundsStart,this._zmax,this.graphic.geometry.spatialReference,this._graphicState.isDraped):this._sizeStart=null}_moveDragUpdateGeometry(){return e=>{if(this.inputState==null||this.inputState.type!=="move")return e;const t=[];for(const n of this._editGeometryOperations.data.components)t.push(...n.vertices);const i=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,a=this._editGeometryOperations.moveVertices(t,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i);return xe(a,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_updateMoveTooltip(e,t){if(t===y.XY||t===y.XY_AXIS){const i=wt(e.mapStart,e.mapEnd,this._graphicState.isDraped?"on-the-ground":"absolute-height");i!=null&&this._moveXYTooltipInfo!=null&&(this._moveXYTooltipInfo.distance=i)}return e}_onResizeGrab({action:e,screenPoint:t}){if(e!=="start"||!t)return;const i=this._calculatePickRay(t);Zi(this._displayBounds.plane,i,R.get())&&(this._updateOperationStartProperties(),this._displayBoundsMarginStart=this._displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(e,t){return ot(e,(i,a,n)=>{this.inputState!=null&&(a.next(s=>(s.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),s)).next(_i(this.view,this._displayBoundsStart.plane)).next(s=>({...s,handle:t})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatio.createDragEventPipelineStep()).next(this._resizeDragUpdateGeometry()).next(s=>{const o={graphic:this.graphic,xScale:s.factor1,yScale:s.factor2};switch(s.action){case"start":case"update":this.emit("graphic-scale",o);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",o)}return s}),n.next(()=>{this.inputState!=null&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return e=>{const t=this._displayBoundsStart,i=e.handle.direction,a=this._displayBoundsMargin,n=this._displayBoundsMarginStart,s=ti(R.get(),t.origin);we(s,s,t.basis1,-i[0]),we(s,s,t.basis2,-i[1]);const o=st(R.get(),e.renderEnd,s),r=st(R.get(),e.renderStart,s),l=ka(e.handle),h=Qi(t),u=Qi(this._displayBounds)/h,d=(g,_)=>{if(g===0)return 1;let m=Re(_),v=.5*g*pi(_,o)/m;const f=v<0?-1:1;l&&(v+=(m-.5*g*pi(_,r)/m)*f*u);const x=m<1.5*n?1:Ma;return m=Math.max(m-n,Ma),f>0&&(v-=a),f*Math.max(f*(v/m),x)};return{...e,factor1:d(i[0],t.basis1),factor2:d(i[1],t.basis2)}}}_resizeDragUpdateGeometry(){return e=>{const t=ti(P(),this._mapBoundsStart.origin);we(t,t,this._mapBoundsStart.basis1,-e.handle.direction[0]),we(t,t,this._mapBoundsStart.basis2,-e.handle.direction[1]);const i=Gt(le(),this._mapBoundsStart.basis1[0],this._mapBoundsStart.basis1[1]);ri(i,i);const a=[];for(const o of this._editGeometryOperations.data.components)a.push(...o.vertices);const n=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,s=this._editGeometryOperations.scaleVertices(a,t,i,e.factor1,e.factor2,n,Ji.REPLACE);return ne(this._mapBoundsStart,this._mapBounds),xe(s,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_onRotateGrab({action:e,screenPoint:t}){if(e!=="start"||!t)return;const i=Ks(this._displayBounds,this.view.renderCoordsHelper,Qs.HEADING,Si()),a=this._calculatePickRay(t);Zi(i,a,R.get())&&(this._updateOperationStartProperties(),this.inputState={type:"rotate",rotatePlane:i})}_createRotateDragPipeline(e){return ot(e,(t,i,a)=>{const n=this.inputState;n!=null&&(i.next(s=>(s.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),s)).next(_i(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdateGeometry()).next(s=>{const o={graphic:this.graphic,angle:ce(s.rotateAngle)};switch(s.action){case"start":case"update":this.emit("graphic-rotate",o);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",o)}return s}),a.next(()=>{this.inputState!=null&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(e){return t=>{const i=fe(e.rotatePlane),a=za(t.renderStart,t.renderEnd,this._displayBounds.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return e=>{const t=ti(P(),this._mapBoundsStart.origin),i=[];for(const s of this._editGeometryOperations.data.components)i.push(...s.vertices);const a=e.action==="start"?Mt.NEW_STEP:Mt.ACCUMULATE_STEPS,n=this._editGeometryOperations.rotateVertices(i,t,e.rotateAngle,a,Ji.REPLACE);return ne(this._mapBoundsStart,this._mapBounds),xe(n,this._mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry,e}}_calculatePickRay(e){const t=es(),i=is(e);return as(this.view.state.camera,i,t),hi(t.direction,t.direction),t}_updateManipulators(){if(!this.visible)return;const e=to(this._displayBounds,q.get());eo(this._rotateManipulator,e,this._displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this._moveZManipulator,e),this._resizeManipulators.forEach((t,i)=>{io(t,this._resizeHandles[i],e,this._displayBounds)})}_updateZMoveHandle(e,t){const i=this._displayBounds,a={basis:i.basis1,direction:-1,position:st(R.get(),i.origin,i.basis1),edge:2},n=q.get();ns(n,t,a.edge*Math.PI/2),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=a.position}_cancel(){const e=this._editGeometryOperations.lastOperation;e!=null&&(this._editGeometryOperations.undo(),this.graphic.geometry=this._editGeometryOperations.data.geometry,ji(e,this._mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const e=this._editGeometryOperations.undo();this.graphic.geometry=this._editGeometryOperations.data.geometry,ji(e,this._mapBounds),this._updateDisplayBounds()}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const e=this._editGeometryOperations.redo();this.graphic.geometry=this._editGeometryOperations.data.geometry,xe(e,this._mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this._resizeManipulators,rotateManipulator:this._rotateManipulator,moveZManipulator:this._moveZManipulator,tooltip:this._tooltip}}};p([c({constructOnly:!0,nonNullable:!0})],j.prototype,"view",void 0),p([c({constructOnly:!0,nonNullable:!0})],j.prototype,"graphic",void 0),p([c({constructOnly:!0,nonNullable:!0})],j.prototype,"enableZ",void 0),p([c()],j.prototype,"enableRotation",void 0),p([c()],j.prototype,"enableScaling",void 0),p([c({constructOnly:!0,type:Ct})],j.prototype,"tooltipOptions",void 0),p([c()],j.prototype,"preserveAspectRatio",null),p([c()],j.prototype,"grabbing",void 0),p([c()],j.prototype,"inputState",void 0),p([c({readOnly:!0})],j.prototype,"type",void 0),p([c()],j.prototype,"_moveUnit",null),j=p([H("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],j);const ya="draped-elevation-changes",dr=10,gr=80,Ma=1e-6;export{Ft as DrawGraphicTool3D,j as ExtentTransformTool,_t as GraphicMoveTool,N as GraphicReshapeTool,B as GraphicTransformTool};
